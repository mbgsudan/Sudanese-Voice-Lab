<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ§ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª - ØµÙˆØªÙ†Ø§</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: radial-gradient(circle at top, #0d1b1e, #000);
      color: #fff;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    h1 {
      color: #00e0b6;
      margin-top: 25px;
      text-shadow: 0 0 12px rgba(0, 224, 198, 0.4);
    }

    .container {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
    }

    select {
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: #0f1518;
      color: #00e0b6;
      font-size: 15px;
      margin: 10px;
      width: 220px;
      text-align: center;
    }

    button.export {
      padding: 10px 20px;
      border-radius: 10px;
      background: linear-gradient(90deg, #00e0b6, #00b4d8);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: 0.3s;
      font-weight: 600;
    }

    button.export:hover {
      opacity: 0.85;
      transform: scale(1.04);
    }

    .stats {
      margin-top: 10px;
      margin-bottom: 15px;
      font-size: 15px;
      color: #ccc;
    }

    .record {
      background: #0f1518;
      border-radius: 12px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.5);
      text-align: right;
    }

    .record h3 {
      margin: 0;
      color: #00e0b6;
      font-size: 18px;
    }

    .status {
      font-size: 14px;
      margin-top: 6px;
    }

    .approved { color: #00e67a; }
    .rejected { color: #ff4d4d; }
    .pending { color: #ffb347; }

    .text {
      font-size: 14px;
      color: #bbb;
      margin-top: 8px;
      line-height: 1.6;
    }

    .progress-bar {
      background: #222;
      border-radius: 8px;
      height: 10px;
      width: 100%;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00e0b6, #00b4d8);
      width: 0%;
      transition: width 0.8s ease;
    }

    .percent-label {
      text-align: left;
      color: #aaa;
      font-size: 13px;
      margin-top: 3px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</h1>
    <p>Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù„Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„Ø§ØªÙƒ Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</p>

    <div>
      <select id="speakerSelect">
        <option value="">ÙƒÙ„ Ø§Ù„Ù…ØªØ­Ø¯Ø«ÙŠÙ†</option>
      </select>
      <button class="export" id="exportBtn">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù„Ù‰ CSV</button>
    </div>

    <div id="recordsContainer">â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm";

    const supabase = createClient(
      "https://qcctqvmwwpsoiexgdqwp.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3Rxdm13d3Bzb2lleGdkcXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI1OTcsImV4cCI6MjA3ODI5ODU5N30.uTfskCuzkZNcvy1QdaOzqlW8km-wcZQoVRFi6k2xndQ"
    );

    const container = document.getElementById("recordsContainer");
    const select = document.getElementById("speakerSelect");
    const exportBtn = document.getElementById("exportBtn");

    let allRecords = [];

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ­Ø¯Ø«ÙŠÙ†
    async function loadSpeakers() {
      const { data, error } = await supabase.from("speakers").select("name").order("name");
      if (error) return console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ­Ø¯Ø«ÙŠÙ†:", error);
      data.forEach(sp => {
        const opt = document.createElement("option");
        opt.value = sp.name;
        opt.textContent = sp.name;
        select.appendChild(opt);
      });
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª
    async function loadRecords(speakerName = "") {
      container.innerHTML = "â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
      const { data, error } = await supabase
        .from("recordings")
        .select(`id, status, created_at, duration, file_size, speakers(name), texts(content)`)
        .order("created_at", { ascending: false });

      if (error) {
        container.innerHTML = "<p>âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>";
        return;
      }

      allRecords = data;
      const filtered = speakerName
        ? data.filter(r => r.speakers?.name === speakerName)
        : data;

      if (!filtered.length) {
        container.innerHTML = "<p>ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù…ØªØ§Ø­Ø©</p>";
        return;
      }

      // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
      const total = filtered.length;
      const approved = filtered.filter(r => r.status === "approved").length;
      const rejected = filtered.filter(r => r.status === "rejected").length;
      const pending = filtered.filter(r => !r.status || r.status === "pending").length;

      container.innerHTML = `
        <div class="stats">
          ğŸ“Š <b>${total}</b> ØªØ³Ø¬ÙŠÙ„ |
          âœ… <span style="color:#00e67a">${approved}</span> Ù…Ù‚Ø¨ÙˆÙ„Ø© |
          âŒ <span style="color:#ff4d4d">${rejected}</span> Ù…Ø±ÙÙˆØ¶Ø© |
          â³ <span style="color:#ffb347">${pending}</span> Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
        </div>
      `;

      for (const r of filtered) {
        const name = r.speakers?.name || "Ù…Ø¬Ù‡ÙˆÙ„";
        const speakerRecs = data.filter(rec => rec.speakers?.name === name);
        const totalRecs = speakerRecs.length;
        const acceptedRecs = speakerRecs.filter(rec => rec.status === "approved").length;
        const progress = totalRecs > 0 ? Math.round((acceptedRecs / totalRecs) * 100) : 0;

        const date = new Date(r.created_at).toLocaleString("ar-EG");
        const duration = r.duration ? `${r.duration}s` : "-";
        const size = r.file_size ? `${(r.file_size / 1024).toFixed(1)} KB` : "-";

        container.innerHTML += `
          <div class="record">
            <h3>${name}</h3>
            <div class="status ${
              r.status === "approved"
                ? "approved"
                : r.status === "rejected"
                ? "rejected"
                : "pending"
            }">Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status || "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"}</div>

            <div class="progress-bar"><div class="progress-fill" style="width:${progress}%;"></div></div>
            <div class="percent-label">ğŸ“ˆ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©: ${progress}%</div>

            <div class="text">ğŸ’¬ Ø§Ù„Ù†Øµ: ${r.texts?.content || "-"}</div>
            <div class="text">ğŸ•“ Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date} | â±ï¸ Ø§Ù„Ù…Ø¯Ø©: ${duration} | ğŸ’¾ Ø§Ù„Ø­Ø¬Ù…: ${size}</div>
          </div>
        `;
      }
    }

    // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ CSV
    function exportToCSV() {
      if (!allRecords.length) {
        alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ± Ø¨Ø¹Ø¯.");
        return;
      }

      const rows = [["Ø§Ø³Ù… Ø§Ù„Ù…ØªØ­Ø¯Ø«", "Ø§Ù„Ø­Ø§Ù„Ø©", "Ø§Ù„Ù†Øµ", "Ø§Ù„ØªØ§Ø±ÙŠØ®", "Ø§Ù„Ù…Ø¯Ø©", "Ø§Ù„Ø­Ø¬Ù…"]];
      allRecords.forEach(r => {
        rows.push([
          r.speakers?.name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
          r.status || "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
          (r.texts?.content || "-").replace(/\n/g, " "),
          new Date(r.created_at).toLocaleString("ar-EG"),
          r.duration ? `${r.duration}s` : "-",
          r.file_size ? `${(r.file_size / 1024).toFixed(1)} KB` : "-"
        ]);
      });

      const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "Sawtna_Records_Report.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ ÙˆØ§Ù„ØªØµÙÙŠØ© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³Ù…
    document.addEventListener("DOMContentLoaded", () => {
      loadSpeakers();
      loadRecords();
      select.addEventListener("change", () => loadRecords(select.value));
      exportBtn.addEventListener("click", exportToCSV);
    });
  </script>
</body>
</html>
