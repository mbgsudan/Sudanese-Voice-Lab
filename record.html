<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ğŸ™ï¸ ØµÙˆØªÙ†Ø§ â€“ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="container">
    <header>
      <img src="logo-full.png" class="logo" alt="ØµÙˆØªÙ†Ø§"/>
      <h2>ğŸ§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ</h2>
      <p class="sub">Ø§Ø®ØªØ± Ø§Ø³Ù…ÙƒØŒ Ø§Ù‚Ø±Ø£ Ø§Ù„Ø¬Ù…Ù„Ø©ØŒ Ø«Ù… Ø³Ø¬Ù‘Ù„ ÙˆØ§Ø±ÙØ¹ Ø§Ù„Ù…Ù‚Ø·Ø¹.</p>
    </header>

    <div class="panel">
      <div class="grid">
        <div class="field">
          <label>Ø§Ù„Ù…ØªØ­Ø¯Ø«</label>
          <select id="speaker"></select>
        </div>
        <div class="field">
          <label>Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
          <select id="textSel"></select>
        </div>
      </div>

      <p id="currentText" class="notice"></p>

      <div class="grid">
        <button id="start" class="btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
        <button id="stop" class="btn-ghost" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
      </div>
      <audio id="player" controls></audio>
      <div class="grid">
        <button id="upload" class="btn-ok" disabled>Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
        <button id="reset" class="btn-ghost" disabled>ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
      </div>
      <p id="msg" class="notice"></p>
    </div>

    <div class="panel" id="adminPanel" style="display:none">
      <h3>ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ù…ØªØ­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</h3>
      <div class="grid">
        <div class="field">
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input id="newName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ­Ø¯Ø«"/>
        </div>
        <div class="field">
          <label>Ø§Ù„Ø¬Ù†Ø³</label>
          <select id="newGender">
            <option value="ØºÙŠØ± Ù…Ø­Ø¯Ø¯">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</option>
            <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
            <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
          </select>
        </div>
        <div class="field">
          <label>Ø§Ù„Ø¹Ù…Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="newAge" type="number" min="5" max="100"/>
        </div>
      </div>
      <button id="addSpeaker" class="btn">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ­Ø¯Ø«</button>
      <p id="addMsg" class="notice"></p>
    </div>

    <div class="footer">ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø­Ù…Ø¯ Ø¨Ø§Ø¨ÙƒØ± ÙˆÙØ±ÙŠÙ‚ ØµÙˆØªÙ†Ø§ 2025 âœ¨</div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm';

    const SUPABASE_URL = "https://qcctqvmwwpsoiexgdqwp.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3Rxdm13d3Bzb2lleGdkcXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI1OTcsImV4cCI6MjA3ODI5ODU5N30.uTfskCuzkZNcvy1QdaOzqlW8km-wcZQoVRFi6k2xndQ";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    const BUCKET = "recordings";

    const $ = (s)=>document.querySelector(s);
    const speakerSel=$('#speaker'), textSel=$('#textSel'), currentText=$('#currentText');
    const startBtn=$('#start'), stopBtn=$('#stop'), uploadBtn=$('#upload'), resetBtn=$('#reset');
    const player=$('#player'), msg=$('#msg');
    const adminPanel=$('#adminPanel'), addSpeaker=$('#addSpeaker'), addMsg=$('#addMsg');

    // ğŸ” Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù
    const pw = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø´Ø±Ù Ø£Ùˆ Ø§Ø¶ØºØ· Ø¥Ù„ØºØ§Ø¡ Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ:');
    if(pw === '70003mbgz'){ adminPanel.style.display='block'; }

    // ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ­Ø¯Ø«ÙŠÙ† ÙˆØ§Ù„Ù†ØµÙˆØµ
    async function loadSpeakers(){
      const { data } = await supabase.from('speakers').select('id,code,name').order('code');
      speakerSel.innerHTML = (data||[]).map(s=>`<option value="${s.id}">${s.code} â€” ${s.name}</option>`).join('');
    }
    async function loadTexts(){
      const { data } = await supabase.from('texts').select('id,code,content').eq('status','available').order('record_count',{ascending:true});
      textSel.innerHTML = (data||[]).map(t=>`<option value="${t.id}" data-content="${encodeURIComponent(t.content)}">${t.code}</option>`).join('');
      if(data?.length) currentText.textContent = decodeURIComponent(textSel.options[0].dataset.content);
    }
    textSel.addEventListener('change',()=>{ currentText.textContent = decodeURIComponent(textSel.options[textSel.selectedIndex].dataset.content); });
    await loadSpeakers(); await loadTexts();

    // ğŸ¤ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
    let mediaRecorder, chunks=[];
    startBtn.onclick=async()=>{
      const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      mediaRecorder=new MediaRecorder(stream);
      chunks=[]; mediaRecorder.ondataavailable=e=>chunks.push(e.data);
      mediaRecorder.onstop=()=>{ const blob=new Blob(chunks,{type:'audio/webm'}); player.src=URL.createObjectURL(blob); uploadBtn.disabled=false; resetBtn.disabled=false; };
      mediaRecorder.start(); startBtn.disabled=true; stopBtn.disabled=false; msg.textContent='Ø¬Ø§Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';
    };
    stopBtn.onclick=()=>{ mediaRecorder?.stop(); startBtn.disabled=false; stopBtn.disabled=true; msg.textContent='ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù.'; };
    resetBtn.onclick=()=>{ player.removeAttribute('src'); uploadBtn.disabled=true; resetBtn.disabled=true; };

    // ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    uploadBtn.onclick=async()=>{
      msg.textContent='Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';
      const blob=new Blob(chunks,{type:'audio/webm'});
      const spId=speakerSel.value, txId=textSel.value;
      const ts=new Date().toISOString().replace(/[:.]/g,'-');
      const fileName=`${spId}_${txId}_${ts}.webm`; const path=`${spId}/${fileName}`;
      const up=await supabase.storage.from(BUCKET).upload(path, blob, {contentType:'audio/webm'});
      if(up.error){ msg.textContent='ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: '+up.error.message; return; }

      const ins=await supabase.from('recordings').insert([{speaker_id:spId, text_id:txId, storage_path:path, qa_status:'pending'}]);
      if(ins.error){ msg.textContent='ÙØ´Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„: '+ins.error.message; return; }

      // ğŸ” ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Øµ
      await supabase.rpc('increment_record_count', { text_uuid: txId });
      msg.textContent='ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…';
      uploadBtn.disabled=true; resetBtn.disabled=true;
      await loadTexts();
    };

    // ğŸ§© Ø¥Ø¶Ø§ÙØ© Ù…ØªØ­Ø¯Ø« Ø¬Ø¯ÙŠØ¯
    addSpeaker.onclick=async()=>{
      const name=$('#newName').value.trim(); const gender=$('#newGender').value; const age=$('#newAge').value;
      if(!name){ addMsg.textContent='ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…'; return; }
      const { data: existing } = await supabase.from('speakers').select('code').order('code',{ascending:false}).limit(1);
      let lastCode = existing?.[0]?.code || 'SPK-000';
      let nextNum = parseInt(lastCode.split('-')[1] || 0) + 1;
      let newCode = 'SPK-' + String(nextNum).padStart(3,'0');
      const ins = await supabase.from('speakers').insert([{ code:newCode, name, gender, age }]);
      if(ins.error){ addMsg.textContent='ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: '+ins.error.message; return; }
      addMsg.textContent=`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${name} Ø¨Ø±Ù…Ø² ${newCode} âœ…`;
      await loadSpeakers();
    };
  </script>
</body>
</html>
