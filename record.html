<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª â€“ Ù…Ù†ØµØ© ØµÙˆØªÙ†Ø§</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<style>
  :root{
    --bg:#0b0b0b; --panel:#111; --muted:#9aa3a9; --text:#eaf2f4;
    --brand:#00e0c6; --brand2:#00b4d8; --ok:#00c97a; --warn:#ffb703; --err:#ff4d4d;
  }
  body{font-family: "Cairo", system-ui, -apple-system, Segoe UI, Arial; background:var(--bg); color:var(--text); margin:0}
  .wrap{max-width:900px; margin:40px auto; background:var(--panel); padding:28px; border-radius:20px; box-shadow:0 0 40px rgba(0,0,0,.45)}
  header{display:flex; align-items:center; gap:14px; justify-content:center; margin-bottom:6px}
  header img{height:62px; width:auto; border-radius:14px}
  h1{margin:6px 0 14px; text-align:center; color:var(--brand)}
  p.tip{color:var(--muted); text-align:center; margin-top:0}
  .row{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:16px 0}
  select, input[type=text]{background:#1a1a1a; color:var(--text); border:1px solid #222; border-radius:12px; padding:10px 12px; min-width:240px}
  .board{background:#0f1314; border:1px dashed #234; border-radius:16px; padding:18px; margin:18px 0}
  .board h3{margin:0 0 8px; color:var(--brand)}
  .sentence{font-size:22px; line-height:1.7}
  .meter-wrap{height:10px; background:#1a2124; border-radius:999px; overflow:hidden; margin:14px 0}
  .meter{height:100%; width:0%; background:linear-gradient(90deg, var(--brand), var(--brand2)); transition:width .08s}
  .soft{color:var(--warn)}
  .danger{color:var(--err)}
  .success{color:var(--ok)}
  .center{text-align:center}
  button{border:0; border-radius:14px; padding:12px 20px; font-size:16px; cursor:pointer}
  .btn{background:#2a2f32; color:var(--text)}
  .btn-start{background:linear-gradient(90deg, var(--brand), var(--brand2)); color:#062; color:#083; color:#062}
  .btn-stop{background:#ff6b6b; color:#120}
  .btn-upload{background:#2d6a4f}
  .note{font-size:14px; color:#aeb9be; margin-top:8px}
  audio{width:100%}
  .mini{font-size:13px;color:#9fb}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <!-- Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ø³Ù… Ø´Ø¹Ø§Ø±Ùƒ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ -->
    <img src="logo-full.png" alt="Ø´Ø¹Ø§Ø± ØµÙˆØªÙ†Ø§" />
    <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª â€“ Ù…Ù†ØµØ© ØµÙˆØªÙ†Ø§ ğŸ™ï¸</h1>
  </header>

  <p class="tip">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø«Ù… Ø§Ø¶ØºØ· â€œØ§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„â€. Ø³Ù†Ø¹Ø±Ø¶ Ø¹Ø¯Ù‘Ù‹Ø§ ØªÙ†Ø§Ø²Ù„ÙŠÙ‹Ø§ Ù…Ø¹ ØªÙ†Ø¨ÙŠÙ‡ Ø«Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.  
  Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ØªØ­Ø³Ù‘Ù† ØµÙˆØªÙƒ ÙˆØªÙ…Ù†Ø¹ Ø§Ù„Ø±ÙØ¹ Ø¥Ù† ÙƒØ§Ù† Ù…Ù†Ø®ÙØ¶Ù‹Ø§ Ø¬Ø¯Ù‹Ø§.</p>

  <div class="row">
    <label>Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ:
      <select id="speakerSelect"><option value="">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡â€¦</option></select>
    </label>
    <label>Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„:
      <input id="sessionCode" type="text" placeholder="S-2025-11-10-A" />
    </label>
    <label>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†:
      <input id="micType" type="text" placeholder="USB / Headset / Built-in" />
    </label>
  </div>

  <div class="board">
    <h3>Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ:</h3>
    <div id="textBox" class="sentence">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµâ€¦</div>
    <div class="note" id="textNote">Ø³ÙŠØ¸Ù‡Ø± Ù†Øµ Ø¬Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„Ùƒ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ.</div>
  </div>

  <div class="meter-wrap" title="Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±">
    <div id="meter" class="meter"></div>
  </div>
  <div class="center">
    <span id="levelLabel" class="mini">Ø¬Ø§Ù‡Ø²: Ø§Ù„ØµÙˆØª Ø¶Ù…Ù† Ø§Ù„Ù…Ø¯Ù‰</span>
  </div>

  <div class="row center">
    <button id="btnStart" class="btn-start">ğŸ™ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    <button id="btnStop" class="btn-stop" disabled>â¹ï¸ Ø£ÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    <button id="btnUpload" class="btn-upload" disabled>â¬†ï¸ Ø§Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
  </div>

  <div id="status" class="center note">Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯.</div>

  <div id="playerWrap" class="board" style="display:none">
    <h3>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©:</h3>
    <audio id="player" controls></audio>
  </div>

</div>

<script type="module">
/* ===== Supabase ===== */
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm";
const SUPABASE_URL = "https://qcctqvmwwpsoiexgdqwp.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3Rxdm13d3Bzb2lleGdkcXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI1OTcsImV4cCI6MjA3ODI5ODU5N30.uTfskCuzkZNcvy1QdaOzqlW8km-wcZQoVRFi6k2xndQ";
const BUCKET = "recordings";
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== Ø¹Ù†Ø§ØµØ± ===== */
const speakerSelect = document.getElementById("speakerSelect");
const sessionCode   = document.getElementById("sessionCode");
const micType       = document.getElementById("micType");
const textBox       = document.getElementById("textBox");
const meterEl       = document.getElementById("meter");
const levelLabel    = document.getElementById("levelLabel");
const btnStart      = document.getElementById("btnStart");
const btnStop       = document.getElementById("btnStop");
const btnUpload     = document.getElementById("btnUpload");
const statusEl      = document.getElementById("status");
const playerWrap    = document.getElementById("playerWrap");
const player        = document.getElementById("player");

/* ===== Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ===== */
let mediaStream, mediaRecorder, chunks=[];
let audioCtx, srcNode, gainNode, analyser;
let levelTimer, rmsSum=0, rmsCount=0, avgRMS=0;
let currentText=null, currentSpeaker=null;
let isRecording=false;

/* Ø¹ØªØ¨Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø© */
const MIN_DURATION_MS = 2500;        // Ø£Ù‚Ù„ Ù…Ø¯Ø© Ù…Ø­Ø³ÙˆØ¨Ø©
const MIN_AVG_RMS     = 0.028;       // Ù„Ùˆ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø£Ù‚Ù„ â†’ Ù†Ø±ÙØ¶ (0.02â€“0.03 Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª)
const GAIN_VALUE      = 1.35;        // ØªÙƒØ¨ÙŠØ± Ø®ÙÙŠÙ Ù„Ù„ØµÙˆØª

/* ===== ØªÙ‡ÙŠØ¦Ø© ===== */
await loadSpeakers();
await pickText();

async function loadSpeakers(){
  const { data, error } = await db.from("speakers").select("id, name").order("name");
  speakerSelect.innerHTML = "";
  if(error || !data?.length){
    speakerSelect.innerHTML = `<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù…Ø§Ø¡</option>`;
    return;
  }
  speakerSelect.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ­Ø¯Ø« â€”</option>` + 
    data.map(s=>`<option value="${s.id}">${s.name}</option>`).join("");
}

async function pickText(){
  // Ù†Øµ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…ØªØ§Ø­
  const { data, error } = await db.from("texts").select("id, code, content").limit(1).order("created_at", { ascending:false });
  if(error || !data?.length){ textBox.textContent="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†."; return; }
  currentText = data[0];
  textBox.textContent = currentText.content;
}

/* ===== Ø§Ù„ØµÙˆØª Ø§Ù„Ø­ÙŠ Ùˆ Ø§Ù„Ù‚ÙŠØ§Ø³ ===== */
async function prepareAudio(){
  mediaStream = await navigator.mediaDevices.getUserMedia({
    audio: { noiseSuppression: true, echoCancellation: true, autoGainControl: false },
    video:false
  });
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  srcNode  = audioCtx.createMediaStreamSource(mediaStream);
  gainNode = audioCtx.createGain(); gainNode.gain.value = GAIN_VALUE;
  analyser = audioCtx.createAnalyser(); analyser.fftSize = 1024;

  srcNode.connect(gainNode).connect(analyser).connect(audioCtx.destination);

  // Ù…Ø¤Ø´Ù‘Ø± Ø§Ù„Ù…Ø³ØªÙˆÙ‰
  const buf = new Uint8Array(analyser.fftSize);
  levelTimer = setInterval(()=>{
    analyser.getByteTimeDomainData(buf);
    // RMS Ù…Ù† Ù…ÙˆØ¬Ø© Ø§Ù„Ø²Ù…Ù†
    let sum=0;
    for(let i=0;i<buf.length;i++){
      const v = (buf[i]-128)/128; // âˆ’1..+1
      sum += v*v;
    }
    const rms = Math.sqrt(sum/buf.length);
    rmsSum += rms; rmsCount++; avgRMS = rmsSum/Math.max(1,rmsCount);

    const pct = Math.min(100, Math.round(rms*180)); // ØªØ­ÙˆÙŠÙ„ Ù„Ù…Ø¤Ø´Ø±
    meterEl.style.width = pct + "%";

    if(rms < 0.018) { levelLabel.textContent = "Ø§Ù„ØµÙˆØª Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ù‹Ø§ â€“ Ù‚Ø±Ù‘Ø¨ Ø§Ù„Ù…Ø§ÙŠÙƒ Ø£Ùˆ ØªÙƒÙ„Ù‘Ù… Ø£Ø¹Ù„Ù‰"; levelLabel.className="danger"; }
    else if(rms < 0.03){ levelLabel.textContent = "Ø§Ù„ØµÙˆØª Ù…Ù†Ø®ÙØ¶ Ù‚Ù„ÙŠÙ„Ù‹Ø§ â€“ Ø§Ù„Ø£ÙØ¶Ù„ ØªØªÙƒÙ„Ù… Ø£Ø¹Ù„Ù‰"; levelLabel.className="soft"; }
    else { levelLabel.textContent = "Ø¬Ø§Ù‡Ø²: Ø§Ù„ØµÙˆØª Ø¶Ù…Ù† Ø§Ù„Ù…Ø¯Ù‰"; levelLabel.className="mini"; }
  }, 80);
}

function cleanupAudio(){
  clearInterval(levelTimer);
  if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop());
  if(audioCtx) audioCtx.close();
  mediaStream = audioCtx = srcNode = gainNode = analyser = null;
  rmsSum=0; rmsCount=0; avgRMS=0;
  meterEl.style.width = "0%";
}

/* ===== Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ===== */
btnStart.onclick = async()=>{
  if(!speakerSelect.value){ alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ù…ØªØ­Ø¯Ø«."); return; }
  if(!currentText){ alert("Ø§Ù„Ù†Øµ ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø§Ù„Ø¢Ù†."); return; }
  currentSpeaker = Number(speakerSelect.value);

  btnStart.disabled = true; btnStop.disabled = false; btnUpload.disabled = true;
  statusEl.textContent = "â³ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØªâ€¦";
  await prepareAudio();

  chunks = [];
  mediaRecorder = new MediaRecorder(mediaStream, { mimeType:"audio/webm" });
  const startedAt = Date.now();

  mediaRecorder.ondataavailable = e=>{ if(e.data.size) chunks.push(e.data); };
  mediaRecorder.onstop = ()=>{
    isRecording=false; btnStop.disabled = true;

    const duration = Date.now() - startedAt;
    const blob = new Blob(chunks, { type:"audio/webm" });

    // Ù‚Ø±Ø§Ø± Ø§Ù„Ø¬ÙˆØ¯Ø©: Ø§Ù„Ù…Ø¯Ø© + Ù…ØªÙˆØ³Ø· RMS
    if(duration < MIN_DURATION_MS){
      statusEl.innerHTML = "âš ï¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù‚ØµÙŠØ± Ø¬Ø¯Ù‹Ø§. Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ Ø¬Ù…Ù„Ø© ÙƒØ§Ù…Ù„Ø© Ø¨ÙˆØ¶ÙˆØ­.";
      btnStart.disabled = false; cleanupAudio(); return;
    }
    if(avgRMS < MIN_AVG_RMS){
      statusEl.innerHTML = "âŒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ù‹Ø§ (ØªÙ… Ø±ÙØ¶Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§). Ø§Ù‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø£Ùˆ Ø§Ø±ÙØ¹ ØµÙˆØªÙƒ Ø«Ù… Ø³Ø¬Ù‘Ù„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.";
      btnStart.disabled = false; cleanupAudio(); return;
    }

    // Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±ÙØ¹
    const url = URL.createObjectURL(blob);
    player.src = url; playerWrap.style.display="block";
    btnUpload.disabled = false;
    statusEl.innerHTML = "âœ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¬ÙŠØ¯ â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹Ù‡ Ø§Ù„Ø¢Ù†.";
    cleanupAudio();
  };

  mediaRecorder.start(100);
  isRecording=true;
  statusEl.textContent = "ğŸ”´ Ù†Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¢Ù†â€¦ ØªØ­Ø¯Ù‘Ø« Ø¨ÙˆØ¶ÙˆØ­ Ù‚Ø±Ø¨ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.";
};

btnStop.onclick = ()=>{
  if(isRecording && mediaRecorder?.state==="recording"){
    mediaRecorder.stop();
    statusEl.textContent = "â¸ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„.";
  }
};

btnUpload.onclick = async()=>{
  btnUpload.disabled = true;
  statusEl.textContent = "â¬†ï¸ Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„â€¦";
  try{
    // ÙƒÙˆÙ‘Ù† Blob Ù…Ù† Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹ (Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„)
    const blob = new Blob(chunks, { type:"audio/webm" });
    const fileName = `${new Date().toISOString().slice(0,10)}/${currentSpeaker}/${currentText.code || "TXT"}-${Date.now()}.webm`;
    const path = `user/${fileName}`;

    const { error:upErr } = await db.storage.from("recordings").upload(path, blob, { contentType:"audio/webm", upsert:false });
    if(upErr) throw upErr;

    const meta = {
      speaker_id: currentSpeaker,
      text_id: currentText.id,
      session_id: sessionCode.value?.trim() || null,
      mic_type: micType.value?.trim() || null,
      storage_path: path,
      status: "pending"
    };
    const { error:insErr } = await db.from("recordings").insert(meta);
    if(insErr) throw insErr;

    statusEl.innerHTML = "ğŸ‰ ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© ØªØ³Ø¬ÙŠÙ„Ùƒ Ù‚Ø±ÙŠØ¨Ù‹Ø§.";
    // Ø§Ø®ØªØ± Ù†ØµÙ‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§
    await pickText();
    btnStart.disabled = false;
    btnUpload.disabled = true;
  }catch(e){
    console.error(e);
    statusEl.innerHTML = "âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
    btnUpload.disabled = false;
  }
};
</script>
</body>
</html>
