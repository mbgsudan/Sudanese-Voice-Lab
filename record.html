
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ØµÙˆØªÙ†Ø§ â€“ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="container">
    <header>
      <img src="logo-full.png" class="logo" alt="ØµÙˆØªÙ†Ø§"/>
      <h2>ğŸ§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ</h2>
      <p class="sub">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ ÙˆØ§Ù„Ù†ØµØŒ Ø«Ù… Ø³Ø¬Ù‘Ù„ ÙˆØ§Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.</p>
    </header>

    <div class="panel">
      <div class="grid">
        <div class="field">
          <label>Ø§Ù„Ù…ØªØ­Ø¯Ø«</label>
          <select id="speaker"></select>
        </div>
        <div class="field">
          <label>Ø§Ù„Ø¬Ù…Ù„Ø©</label>
          <select id="textSel"></select>
        </div>
      </div>
      <div class="grid">
        <div class="field">
          <label>Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</label>
          <input id="sessionId" placeholder="S-YYYY-MM-DD-A"/>
        </div>
        <div class="field">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</label>
          <input id="micType" value="USB"/>
        </div>
      </div>
      <div class="separator"></div>
      <p id="currentText" class="notice"></p>
      <div class="grid">
        <button id="start" class="btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
        <button id="stop" class="btn-ghost" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
      </div>
      <audio id="player" controls></audio>
      <div class="grid">
        <button id="upload" class="btn-ok" disabled>Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
        <button id="reset" class="btn-ghost" disabled>ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
      </div>
      <p id="msg" class="notice"></p>
    </div>

    <div class="footer">ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø­Ù…Ø¯ Ø¨Ø§Ø¨ÙƒØ± ÙˆÙØ±ÙŠÙ‚ ØµÙˆØªÙ†Ø§ 2025 âœ¨</div>
  </div>

  <script type="module">
    import { supabase, BUCKET } from './config.js';
    const $ = (s)=>document.querySelector(s);
    const speakerSel=$('#speaker'), textSel=$('#textSel'), sessionId=$('#sessionId'), micType=$('#micType'), currentText=$('#currentText');
    const startBtn=$('#start'), stopBtn=$('#stop'), uploadBtn=$('#upload'), resetBtn=$('#reset'), player=$('#player'), msg=$('#msg');

    async function preload(){
      const sp=await supabase.from('speakers').select('id,code,name').order('code');
      speakerSel.innerHTML=(sp.data||[]).map(s=>`<option value="${s.id}">${s.code} â€” ${s.name||''}</option>`).join('');
      const tx=await supabase.from('texts').select('id,code,content').order('code');
      textSel.innerHTML=(tx.data||[]).map(t=>`<option value="${t.id}" data-content="${encodeURIComponent(t.content)}">${t.code}</option>`).join('');
      if(tx.data&&tx.data[0]) currentText.textContent=decodeURIComponent(textSel.options[0].dataset.content);
      const d=new Date().toISOString().slice(0,10); sessionId.value=`S-${d}-A`;
    }
    textSel.addEventListener('change',()=>{ const opt=textSel.options[textSel.selectedIndex]; currentText.textContent=decodeURIComponent(opt.dataset.content||'');});
    preload();

    let mediaRecorder, chunks=[];
    startBtn.onclick=async()=>{
      try{
        const stream=await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder=new MediaRecorder(stream,{mimeType:'audio/webm'}); chunks=[];
        mediaRecorder.ondataavailable=e=>chunks.push(e.data);
        mediaRecorder.onstop=()=>{ const blob=new Blob(chunks,{type:'audio/webm'}); player.src=URL.createObjectURL(blob); uploadBtn.disabled=false; resetBtn.disabled=false; };
        mediaRecorder.start(); startBtn.disabled=true; stopBtn.disabled=false; msg.textContent='Ø¬Ø§Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';
      }catch(e){ msg.textContent='Ù„Ù… ÙŠØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.'; }
    };
    stopBtn.onclick=()=>{ mediaRecorder?.stop(); startBtn.disabled=false; stopBtn.disabled=true; msg.textContent='ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„.'; };
    resetBtn.onclick=()=>{ player.removeAttribute('src'); uploadBtn.disabled=true; resetBtn.disabled=true; };

    uploadBtn.onclick=async()=>{
      msg.textContent='Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';
      const blob=new Blob(chunks,{type:'audio/webm'});
      const spId=speakerSel.value, txId=textSel.value; if(!spId||!txId){ msg.textContent='Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ­Ø¯Ø« ÙˆØ§Ù„Ù†Øµ Ø£ÙˆÙ„Ø§Ù‹.'; return; }
      const sp=await supabase.from('speakers').select('code,name').eq('id',spId).maybeSingle();
      const tx=await supabase.from('texts').select('code,content').eq('id',txId).maybeSingle();
      const spCode=sp.data?.code||'SPK', txCode=tx.data?.code||'TXT'; const ts=new Date().toISOString().replace(/[:.]/g,'-');
      const fileName=`${spCode}_${txCode}_T1_${ts}.webm`; const path=`${spCode}/${sessionId.value}/${fileName}`;

      const up=await supabase.storage.from(BUCKET).upload(path, blob, {contentType:'audio/webm', upsert:false});
      if(up.error){ msg.textContent='ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: '+up.error.message; return; }
      const ins=await supabase.from('recordings').insert({speaker_id:spId, text_id:txId, storage_path:path, qa_status:'pending', mic_type:micType.value||null, session_id:sessionId.value||null});
      if(ins.error){ msg.textContent='ØªÙ… Ø§Ù„Ø±ÙØ¹ Ù„ÙƒÙ† ÙØ´Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„: '+ins.error.message; return; }
      msg.textContent='ØªÙ… Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…'; uploadBtn.disabled=true;
    };
  </script>
</body>
</html>
