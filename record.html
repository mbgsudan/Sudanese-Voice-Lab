<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ุชุณุฌูู ุตูุช ุฌุฏูุฏ ๐๏ธ | ุตูุชูุง</title>
  <link rel="stylesheet" href="styles.css"/>
  <!-- ุฅุนุฏุงุฏุงุช -->
  <script src="config.js"></script>
  <!-- Supabase -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm"></script>
</head>
<body>
  <div class="container">
    <h1>ุชุณุฌูู ุตูุช ุฌุฏูุฏ ๐ค</h1>

    <div class="card">
      <div class="row center">
        <span class="stat">๐ ุงูุฑุฃ ุงููุต ุจูุถูุญ ูุจุทุจูุนุชู ุงูุณูุฏุงููุฉ</span>
        <span class="stat" style="margin-inline-start:auto">
          <span class="counter" id="progCount">0</span>/<span id="totalCount">0</span>
        </span>
      </div>

      <div class="card2" style="padding:16px;border-radius:12px;margin-top:10px">
        <h2 style="text-align:center;margin:6px 0">ุงููุต ุงูุญุงูู:</h2>
        <p id="textContent" class="center" style="font-size:22px;min-height:64px;margin:6px 0">ุฌุงุฑู ุงูุชุญูููโฆ</p>

        <div class="row center" style="margin-top:10px">
          <button class="btn outline" id="prevBtn">โฎ๏ธ ูุต ุณุงุจู</button>
          <button class="btn outline" id="skipBtn">โญ๏ธ ุชุฎุทู ุงููุต</button>
        </div>
      </div>

      <div class="row center" style="margin-top:16px">
        <button class="btn" id="recBtn">ุงุจุฏุฃ ุงูุชุณุฌูู ๐๏ธ</button>
      </div>

      <div class="audioBox" id="previewBox" style="display:none">
        <audio id="preview" controls></audio>
        <div class="row" style="margin-top:8px">
          <button class="btn ok" id="uploadBtn">ุฑูุน โ</button>
          <button class="btn bad" id="redoBtn">ุฅุนุงุฏุฉ ุงูุชุณุฌูู โบ</button>
        </div>
      </div>

      <p class="stat" id="hint"></p>
    </div>
  </div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm";

  // ====== ุฅุนุฏุงุฏุงุช ุนุงูุฉ ======
  const sb = createClient(window.SAWTNA.SUPABASE_URL, window.SAWTNA.SUPABASE_ANON);
  const BUCKET = window.SAWTNA.BUCKET;

  // โูููุฉโ ุงููุชุญุฏุซ ุงูุจุณูุทุฉ (ุงุณู ููุท ูุคูุชูุง โ ูู ุนูุฏู ุชุญุฏูุฏ ุงุณู ูู ููุงู ุขุฎุฑ ุงุณุชูุฑุฏู ูู localStorage)
  const SPEAKER_NAME_KEY = "sawtna_speaker_name";
  let speakerName = localStorage.getItem(SPEAKER_NAME_KEY) || "ูุณุงูู";

  // ุนูุงุตุฑ ุงููุงุฌูุฉ
  const textEl = document.getElementById('textContent');
  const progCountEl = document.getElementById('progCount');
  const totalCountEl = document.getElementById('totalCount');
  const hint = document.getElementById('hint');
  const recBtn = document.getElementById('recBtn');
  const prevBtn = document.getElementById('prevBtn');
  const skipBtn = document.getElementById('skipBtn');
  const previewBox = document.getElementById('previewBox');
  const preview = document.getElementById('preview');
  const uploadBtn = document.getElementById('uploadBtn');
  const redoBtn = document.getElementById('redoBtn');

  // ุญุงูุฉ ูุตูุต
  let texts = [];            // [{id, content}]
  let usedIds = new Set(JSON.parse(localStorage.getItem('sawtna_used_texts') || '[]')); // ููุน ุชูุฑุงุฑ ุงููุต
  let indexStack = [];       // ูุฒุฑ โูุต ุณุงุจูโ
  let current = null;

  // ูููุฑูููู
  let mediaRecorder, chunks = [];

  // ====== ุชุญููู ุงููุตูุต ======
  async function loadTexts() {
    // ูุฌูุจ ููุท ุงููุตูุต ุงููุนุงูุฉ (ูู ุนูุฏู ุนููุฏ active=true). ุฅู ูู ููุฌุฏ ุงุญุฐู ุงูุดุฑุท.
    const { data, error } = await sb.from('texts')
      .select('id, content')
      .order('id', { ascending: true });

    if (error) { textEl.textContent = 'ุชุนุฐุฑ ุชุญููู ุงููุตูุต'; return; }
    texts = data || [];
    totalCountEl.textContent = texts.length.toString();
    pickNext();
  }

  function pickNext(goBack = false) {
    if (goBack && indexStack.length > 0) {
      const prev = indexStack.pop();
      current = prev;
      textEl.textContent = prev.content;
      return;
    }

    // ุงุฎุชุฑ ุฃูู ูุต ุบูุฑ ูุณุชุฎุฏู
    const next = texts.find(t => !usedIds.has(t.id));
    if (!next) {
      textEl.textContent = 'ุฃุญุณูุช! ุฃูููุช ูู ุงููุตูุต ุงููุชุงุญุฉ ๐';
      recBtn.disabled = true;
      skipBtn.disabled = true;
      prevBtn.disabled = (indexStack.length === 0);
      return;
    }
    if (current) indexStack.push(current);
    current = next;
    textEl.textContent = next.content;
    prevBtn.disabled = (indexStack.length === 0);
  }

  // ====== ุงูุชุณุฌูู ======
  recBtn.addEventListener('click', async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }});
      mediaRecorder = new MediaRecorder(stream);
      chunks = [];
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        preview.src = URL.createObjectURL(blob);
        previewBox.style.display = 'block';
      };
      mediaRecorder.start();
      recBtn.textContent = 'ุฅููุงู ุงูุชุณุฌูู โน๏ธ';
      recBtn.onclick = () => { mediaRecorder.stop(); recBtn.textContent = 'ุงุจุฏุฃ ุงูุชุณุฌูู ๐๏ธ'; recBtn.onclick = null; };
      hint.textContent = 'ุฌุงุฑู ุงูุชุณุฌููโฆ ุชุญุฏุซ ุจูุฑุจ ุงููููุฑูููู ูุงุจุชุนุฏ ุนู ุงูุถูุถุงุก.';
    } catch(e) {
      hint.textContent = 'ูุง ูููู ุงููุตูู ูููููุฑูููู.';
    }
  });

  redoBtn.addEventListener('click', () => {
    previewBox.style.display = 'none';
    preview.removeAttribute('src');
  });

  // ====== ุงูุฑูุน ======
  uploadBtn.addEventListener('click', async () => {
    if (!current || !preview.src) return;
    uploadBtn.disabled = true;

    // ุงุจุญุซ (ุฃู ุฃูุดุฆ) ุงููุชุญุฏุซ ุจุงูุงุณู
    let speakerId = null;
    {
      const { data: sp } = await sb.from('speakers').select('id').eq('name', speakerName).maybeSingle();
      if (sp?.id) speakerId = sp.id;
      else {
        const { data: ins } = await sb.from('speakers').insert([{ name: speakerName }]).select('id').single();
        speakerId = ins.id;
      }
    }

    // ุฌููุฒ ุงูููู
    const res = await fetch(preview.src); const blob = await res.blob();
    const objectPath = `${speakerName}-${current.id}-${Date.now()}.webm`;

    // ุงุฑูุน ุฅูู ุงูุชุฎุฒูู
    const up = await sb.storage.from(BUCKET).upload(objectPath, blob, { contentType: 'audio/webm', upsert:false });
    if (up.error) { hint.textContent = 'ุชุนุฐุฑ ุงูุฑูุน'; uploadBtn.disabled=false; return; }

    // ุณุฌูู ูู recordings (pending ุงูุชุฑุงุถููุง)
    const insRec = await sb.from('recordings').insert([{
      speaker_id: speakerId,
      text_id: current.id,
      storage_path: objectPath,
      status: 'pending'
    }]);

    if (insRec.error) { hint.textContent = 'ุฎุทู ุฃุซูุงุก ุงูุญูุธ.'; uploadBtn.disabled=false; return; }

    // ุญุฏูุซ ุงูุชูุฏู ูุงุฐูุจ ูููุต ุงูุชุงูู
    usedIds.add(current.id);
    localStorage.setItem('sawtna_used_texts', JSON.stringify([...usedIds]));
    progCountEl.textContent = usedIds.size.toString();
    hint.textContent = 'ุชู ุงูุฑูุน ุจูุฌุงุญ โ';
    previewBox.style.display = 'none';
    preview.removeAttribute('src');
    pickNext();
    uploadBtn.disabled = false;
  });

  // ุชุฎุทู/ุณุงุจู
  skipBtn.addEventListener('click', () => pickNext(false));
  prevBtn.addEventListener('click', () => pickNext(true));

  // ุงุจุฏุฃ
  progCountEl.textContent = usedIds.size.toString();
  loadTexts();
</script>
</body>
</html>
