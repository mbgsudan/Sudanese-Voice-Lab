<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª - ØµÙˆØªÙ†Ø§</title>
<style>
body{font-family:Cairo,Arial,sans-serif;background:#0b0b0b;color:#fff;margin:0;padding:0;text-align:center}
.container{max-width:600px;margin:40px auto;background:#111;padding:25px;border-radius:18px;box-shadow:0 0 25px rgba(0,0,0,.5)}
h1{color:#00e0b6;margin-bottom:15px}
h2{color:#ccc;font-weight:500}
button{background:#00e0b6;color:#111;border:none;padding:12px 24px;margin:10px;border-radius:10px;font-size:16px;cursor:pointer}
button:disabled{background:#333;color:#888;cursor:not-allowed}
.meter{height:12px;background:#333;border-radius:6px;overflow:hidden;margin-top:10px}
.meter div{height:100%;background:#00e0b6;width:0%;transition:width 0.1s}
#levelLabel{margin-top:8px;font-size:14px}
.danger{color:#ff4d4d}
.soft{color:#ffb703}
.mini{color:#00e0b6}
audio{margin-top:20px;width:100%}
#textBox{margin-top:20px;font-size:18px;background:#1a1a1a;padding:10px;border-radius:8px}
</style>
</head>
<body>
<div class="container">
  <img src="logo-full.png" alt="Ø´Ø¹Ø§Ø± ØµÙˆØªÙ†Ø§" style="width:120px;margin-bottom:10px">
  <h1>ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙƒ Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ÙŠØ©</h1>
  <h2 id="speakerName"></h2>

  <div id="textBox">â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµ...</div>

  <div class="meter"><div id="meterBar"></div></div>
  <p id="levelLabel">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†...</p>

  <div style="margin-top:15px">
    <button id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    <button id="stopBtn" disabled>Ø£ÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
  </div>

  <audio id="player" controls style="display:none"></audio>
  <button id="uploadBtn" style="display:none">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm";

const supabase = createClient(
  "https://qcctqvmwwpsoiexgdqwp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3Rxdm13d3Bzb2lleGdkcXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI1OTcsImV4cCI6MjA3ODI5ODU5N30.uTfskCuzkZNcvy1QdaOzqlW8km-wcZQoVRFi6k2xndQ"
);
const BUCKET = "recordings";

let mediaRecorder, chunks=[], mediaStream, audioCtx, analyser, gainNode;
let rmsSum=0,rmsCount=0,avgRMS=0,levelTimer;
const meterEl=document.getElementById("meterBar");
const levelLabel=document.getElementById("levelLabel");
const textBox=document.getElementById("textBox");
const startBtn=document.getElementById("startBtn");
const stopBtn=document.getElementById("stopBtn");
const uploadBtn=document.getElementById("uploadBtn");
const player=document.getElementById("player");

let currentTextId=null;
let currentSpeaker=null;

/* === ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ­Ø¯Ø« ÙˆØ§Ù„Ù†Øµ === */
async function initData(){
  const { data:speakers } = await supabase.from("speakers").select("id,name").limit(1);
  currentSpeaker = speakers?.[0] || {id:null,name:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"};
  document.getElementById("speakerName").textContent = `Ø§Ù„Ù…ØªØ­Ø¯Ø«: ${currentSpeaker.name}`;
  await loadNextText();
}

async function loadNextText(){
  const { data:texts } = await supabase.from("texts").select("id,content").limit(1);
  if(!texts?.length){textBox.textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØµÙˆØµ Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù†.";return;}
  currentTextId=texts[0].id;
  textBox.textContent=texts[0].content;
}

/* === ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙˆØª Ø¨Ø¯ÙˆÙ† ØµØ¯Ù‰ === */
async function prepareAudio(){
  mediaStream = await navigator.mediaDevices.getUserMedia({
    audio:{
      noiseSuppression:true,
      echoCancellation:true,
      autoGainControl:false
    },
    video:false
  });
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const srcNode=audioCtx.createMediaStreamSource(mediaStream);
  gainNode=audioCtx.createGain();
  gainNode.gain.value=1.2;
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=1024;
  srcNode.connect(gainNode).connect(analyser); // Ø¨Ø¯ÙˆÙ† Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØª Ù„Ù„Ø³Ù…Ø§Ø¹Ø§Øª

  const buf=new Uint8Array(analyser.fftSize);
  levelTimer=setInterval(()=>{
    analyser.getByteTimeDomainData(buf);
    let sum=0;
    for(let i=0;i<buf.length;i++){const v=(buf[i]-128)/128;sum+=v*v;}
    const rms=Math.sqrt(sum/buf.length);
    rmsSum+=rms;rmsCount++;avgRMS=rmsSum/Math.max(1,rmsCount);
    const pct=Math.min(100,Math.round(rms*180));
    meterEl.style.width=pct+"%";
    if(rms<0.018){levelLabel.textContent="Ø§Ù„ØµÙˆØª Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ù‹Ø§ â€“ Ù‚Ø±Ù‘Ø¨ Ø§Ù„Ù…Ø§ÙŠÙƒ";levelLabel.className="danger";}
    else if(rms<0.03){levelLabel.textContent="Ø§Ù„ØµÙˆØª Ù…Ù†Ø®ÙØ¶ Ù‚Ù„ÙŠÙ„Ù‹Ø§";levelLabel.className="soft";}
    else{levelLabel.textContent="âœ… Ø§Ù„ØµÙˆØª Ù…Ù…ØªØ§Ø²ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡";levelLabel.className="mini";}
  },80);
}

/* === Ø§Ù„ØªØ³Ø¬ÙŠÙ„ === */
startBtn.onclick=async()=>{
  chunks=[];
  await prepareAudio();
  mediaRecorder=new MediaRecorder(mediaStream);
  mediaRecorder.ondataavailable=e=>chunks.push(e.data);
  mediaRecorder.onstop=()=>{
    clearInterval(levelTimer);
    const blob=new Blob(chunks,{type:"audio/webm"});
    player.src=URL.createObjectURL(blob);
    player.style.display="block";
    uploadBtn.style.display="inline-block";
  };
  mediaRecorder.start();
  startBtn.disabled=true;stopBtn.disabled=false;
  levelLabel.textContent="Ø¬Ø§Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„... ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù† ğŸ¤";
}
stopBtn.onclick=()=>{
  mediaRecorder.stop();
  startBtn.disabled=false;stopBtn.disabled=true;
}

/* === Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ === */
uploadBtn.onclick=async()=>{
  const blob=new Blob(chunks,{type:"audio/webm"});
  const fileName=`rec_${Date.now()}.webm`;
  const { error }=await supabase.storage.from(BUCKET).upload(fileName,blob);
  if(error){alert("ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„");return;}
  await supabase.from("recordings").insert({
    speaker_id:currentSpeaker.id,
    text_id:currentTextId,
    storage_path:fileName,
    status:"pending"
  });
  alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
  player.style.display="none";
  uploadBtn.style.display="none";
  await loadNextText();
};

initData();
</script>
</body>
</html>
