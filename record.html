<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª - ØµÙˆØªÙ†Ø§</title>
<style>
body {
  font-family: 'Cairo', sans-serif;
  background: #0b0b0b;
  color: #fff;
  text-align: center;
  margin: 0;
  padding: 40px 10px;
}
.container {
  max-width: 600px;
  margin: auto;
  background: #111;
  padding: 30px;
  border-radius: 18px;
  box-shadow: 0 0 30px rgba(0,255,200,0.1);
}
h1 {
  color: #00e0b6;
  margin-bottom: 10px;
}
p {
  color: #ccc;
}
label {
  display: block;
  margin-top: 15px;
  font-weight: bold;
  color: #eee;
}
input, select {
  width: 90%;
  padding: 10px;
  border-radius: 10px;
  border: none;
  margin-top: 8px;
  background: #222;
  color: #fff;
}
button {
  padding: 12px 25px;
  border: none;
  border-radius: 12px;
  margin: 10px 8px;
  font-size: 16px;
  cursor: pointer;
  transition: .3s;
}
#startBtn {
  background: linear-gradient(90deg,#00e0b6,#00b4d8);
  color: #fff;
}
#stopBtn {
  background: #ff4d4d;
  color: #fff;
}
#startBtn:hover, #stopBtn:hover {
  transform: scale(1.05);
}
audio {
  margin-top: 15px;
  width: 100%;
}
#volumeBar {
  width: 100%;
  height: 10px;
  background: #222;
  border-radius: 6px;
  overflow: hidden;
  margin: 10px 0;
}
#volumeLevel {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg,#00e0b6,#00b4d8);
  transition: width .1s ease;
}
.status {
  margin-top: 15px;
  font-size: 15px;
  color: #aaa;
}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª - ØµÙˆØªÙ†Ø§</h1>
  <p>Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„" ÙˆØªØ­Ø¯Ø« Ø¨ÙˆØ¶ÙˆØ­ Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†.</p>

  <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ­Ø¯Ø«:</label>
  <input type="text" id="speakerName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§">

  <label>Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</label>
  <input type="text" id="textContent" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙŠØ§ Ø¬Ù…Ø§Ø¹Ø©.">

  <div id="volumeBar"><div id="volumeLevel"></div></div>
  <div class="status" id="volumeStatus">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª: Ø¬Ø§Ù‡Ø²</div>

  <button id="startBtn">â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
  <button id="stopBtn" disabled>â¹ï¸ Ø£ÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>

  <audio id="audioPlayer" controls style="display:none;"></audio>

  <p id="uploadStatus"></p>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm";

const supabase = createClient(
  "https://qcctqvmwwpsoiexgdqwp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3Rxdm13d3Bzb2lleGdkcXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI1OTcsImV4cCI6MjA3ODI5ODU5N30.uTfskCuzkZNcvy1QdaOzqlW8km-wcZQoVRFi6k2xndQ"
);
const BUCKET = "recordings";

let mediaRecorder, audioChunks = [];
let audioContext, analyser, gainNode, source;
let animationFrame;

async function startRecording() {
  const name = document.getElementById("speakerName").value.trim();
  const text = document.getElementById("textContent").value.trim();
  if (!name || !text) {
    alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ­Ø¯Ø« ÙˆØ§Ù„Ù†Øµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.");
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: { noiseSuppression: true, echoCancellation: true, autoGainControl: true }
    });

    audioContext = new AudioContext();
    source = audioContext.createMediaStreamSource(stream);
    gainNode = audioContext.createGain();
    gainNode.gain.value = 2.0; // ØªØ¶Ø®ÙŠÙ… Ù…ØªÙˆØ³Ø· Ø·Ø¨ÙŠØ¹ÙŠ
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;

    source.connect(gainNode);
    gainNode.connect(analyser);
    const destination = audioContext.createMediaStreamDestination();
    gainNode.connect(destination);

    mediaRecorder = new MediaRecorder(destination.stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => saveRecording(name, text);

    mediaRecorder.start();
    visualizeVolume();
    document.getElementById("startBtn").disabled = true;
    document.getElementById("stopBtn").disabled = false;
    document.getElementById("volumeStatus").textContent = "ğŸ™ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";
  } catch (err) {
    alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†.");
  }
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== "inactive") {
    mediaRecorder.stop();
    cancelAnimationFrame(animationFrame);
    document.getElementById("startBtn").disabled = false;
    document.getElementById("stopBtn").disabled = true;
  }
}

async function saveRecording(name, text) {
  const blob = new Blob(audioChunks, { type: "audio/webm" });
  const fileName = `${name}_${Date.now()}.webm`;
  const filePath = `${fileName}`;

  document.getElementById("uploadStatus").textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";

  const { error } = await supabase.storage.from(BUCKET).upload(filePath, blob);
  if (error) {
    alert("âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù");
    return;
  }

  await supabase.from("recordings").insert([
    {
      speaker_name: name,
      text_content: text,
      storage_path: filePath,
      status: "pending"
    }
  ]);

  const url = URL.createObjectURL(blob);
  const player = document.getElementById("audioPlayer");
  player.src = url;
  player.style.display = "block";
  document.getElementById("uploadStatus").textContent = "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!";
}

function visualizeVolume() {
  const dataArray = new Uint8Array(analyser.frequencyBinCount);
  function draw() {
    analyser.getByteFrequencyData(dataArray);
    const avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
    const volume = Math.min(100, (avg / 128) * 100);
    document.getElementById("volumeLevel").style.width = volume + "%";
    const status = document.getElementById("volumeStatus");
    if (volume < 20) status.textContent = "ğŸ”ˆ Ø§Ù„ØµÙˆØª Ù…Ù†Ø®ÙØ¶";
    else if (volume > 80) status.textContent = "ğŸ“¢ Ø§Ù„ØµÙˆØª Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ù‹Ø§";
    else status.textContent = "ğŸ¤ Ø§Ù„ØµÙˆØª Ø¬ÙŠØ¯";
    animationFrame = requestAnimationFrame(draw);
  }
  draw();
}

document.getElementById("startBtn").addEventListener("click", startRecording);
document.getElementById("stopBtn").addEventListener("click", stopRecording);
</script>
</body>
</html>
