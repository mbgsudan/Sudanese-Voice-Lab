<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙƒ Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ÙŠØ© | ØµÙˆØªÙ†Ø§</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0b0b; --card:#111; --mute:#222;
      --text:#e9f0f1; --muted:#aab7b8;
      --brand:#00e0c6; --brand2:#00b4d8; --ok:#1dd1a1; --warn:#ff6b6b;
      --glow: 0 0 25px rgba(0,224,198,.35), 0 0 60px rgba(0,180,216,.25);
    }
    *{box-sizing:border-box}
    html,body{background:var(--bg);color:var(--text);margin:0;font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:24px}
    .card{background:var(--card);border-radius:20px;padding:28px 20px;box-shadow:0 10px 60px rgba(0,0,0,.35);position:relative;overflow:hidden}
    header{display:flex;align-items:center;gap:14px;justify-content:center;margin-top:8px}
    header img{width:96px;height:96px;object-fit:contain;filter:drop-shadow(0 6px 12px rgba(0,0,0,.35))}
    h1{margin:.25rem 0 0;font-size:clamp(22px,3.5vw,34px);font-weight:800;letter-spacing:.4px}
    .hint{color:var(--muted);text-align:center;margin:8px auto 18px;max-width:720px;line-height:1.8}
    .row{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap}
    select, input[type=text]{background:#0f1314;border:1px solid #263238;color:var(--text);padding:10px 12px;border-radius:12px;min-width:240px;outline:none}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#0e1516;border:1px dashed #1f2a2c;padding:8px 12px;border-radius:999px;color:var(--muted);font-size:14px}
    .textBox{margin:18px auto 8px;background:#0f1314;border:1px solid #223136;border-radius:16px;padding:18px}
    .textBox h3{margin:0 0 10px;color:var(--brand)}
    .textBox p{margin:8px 0 0;font-size:20px;line-height:2}
    .meter{height:10px;background:#0f1314;border:1px solid #223136;border-radius:999px;overflow:hidden}
    .meter > span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#2ecc71,#f1c40f,#e67e22,#e74c3c)}
    .buttons{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:16px}
    button{border:0;border-radius:14px;color:#fff;font-weight:700;cursor:pointer;padding:12px 18px;min-width:160px;transition:transform .04s ease, box-shadow .2s ease, opacity .2s ease}
    .start{background:linear-gradient(90deg,var(--brand),var(--brand2));box-shadow:var(--glow)}
    .start.glow{animation:pulse 1.2s ease-in-out infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 rgba(0,224,198,.0)}50%{box-shadow:var(--glow)}100%{box-shadow:0 0 0 rgba(0,224,198,.0)}}
    .stop{background:#3a3f44}
    .upload{background:var(--ok)}
    .disabled{opacity:.55;pointer-events:none;filter:grayscale(.2)}
    .status{margin-top:10px;text-align:center;color:var(--muted)}
    .badge{font-size:13px;display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #254248;background:#0f1a1a;color:#8de0d4}
    .bar{height:6px;border-radius:999px;background:#142224;overflow:hidden}
    .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#00e0c6,#00b4d8)}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .count{background:#0f1314;border:1px solid #1f3134;padding:26px 32px;border-radius:20px;text-align:center;box-shadow:var(--glow)}
    .count h2{margin:0 0 6px}
    .count .big{font-size:56px;font-weight:800;margin:4px 0 0;color:#fff}
    .footerNote{margin-top:18px;text-align:center;color:#819499;font-size:13px}
    .success{color:#25d39c}
    .error{color:#ff7b7b}
    .ghost{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <img src="logo-full.png" alt="Ø´Ø¹Ø§Ø± ØµÙˆØªÙ†Ø§" />
        <div>
          <h1>ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙƒ Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ÙŠØ© ğŸ™ï¸</h1>
        </div>
      </header>

      <p class="hint">
        Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ ÙˆØ§Ø¶ØºØ· <strong>Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</strong>. Ø³ÙŠØ¸Ù‡Ø± Ø¹Ø¯Ù‘ ØªÙ†Ø§Ø²Ù„ÙŠ (3 Ø«ÙˆØ§Ù†Ù) Ù…Ø¹ ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ Ø«Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
        ØªØ­Ø¯Ù‘Ø« Ø¨ÙˆØ¶ÙˆØ­ Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø«Ù… Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.
      </p>

      <div class="row">
        <label class="pill">Ø§Ù„Ù…ØªØ­Ø¯Ù‘Ø«:
          <select id="speakerSelect" title="Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…ØªØ­Ø¯Ø«"></select>
        </label>

        <label class="pill">Ù†ÙˆØ¹ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†:
          <input type="text" id="micType" placeholder="USB / Ù‡Ø§ØªÙ / Ù„Ø§Ø¨ØªÙˆØ¨" style="min-width:180px">
        </label>

        <span class="badge" id="totalsBadge">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù†ØµÙ‘Ø©: <b id="totalCount">â€”</b></span>
      </div>

      <div class="textBox">
        <h3>Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ:</h3>
        <p id="currentText">â€¦ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµ</p>
        <div class="bar" style="margin-top:10px"><i id="progressBar"></i></div>
        <div class="status">
          <span id="attemptsInfo">Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ: â€”</span>
          <span style="margin:0 8px">â€¢</span>
          <span id="speakerStats">Ø³Ø¬Ù‘Ù„Øª Ø¨ØµÙˆØªÙƒ: â€” Ù…Ù„Ù</span>
        </div>
      </div>

      <div class="meter" title="Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†"><span id="vu"></span></div>
      <p class="status" id="micStatus">Ø¬Ø§Ø±Ù ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†â€¦</p>

      <div class="buttons">
        <button id="startBtn" class="start disabled">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ âœï¸</button>
        <button id="stopBtn" class="stop disabled">Ø£ÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â¹ï¸</button>
        <button id="uploadBtn" class="upload disabled">Ø§Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â¬†ï¸</button>
      </div>

      <p class="status" id="saveStatus"></p>
      <p class="footerNote">âœ¨ Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø³ÙŠØ¸Ù‡Ø± Ù†Øµ Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</p>
    </div>
  </div>

  <!-- Ø§Ù„Ø¹Ø¯Ù‘ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ -->
  <div class="overlay" id="overlay">
    <div class="count">
      <h2>Ø§Ø³ØªØ¹Ø¯â€¦ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯</h2>
      <div class="big" id="countNum">3</div>
    </div>
  </div>

  <!-- Ù…Ø´ØºÙ„ Ù…Ø®ÙÙŠ Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù -->
  <audio id="preview" class="ghost" controls></audio>

  <!-- Supabase -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm";

    // === Ø¥Ø¹Ø¯Ø§Ø¯ Supabase ===
    const SUPABASE_URL = "https://qcctqvmwwpsoiexgdqwp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3Rxdm13d3Bzb2lleGdkcXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI1OTcsImV4cCI6MjA3ODI5ODU5N30.uTfskCuzkZNcvy1QdaOzqlW8km-wcZQoVRFi6k2xndQ";
    const BUCKET = "recordings";
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===
    const speakerSelect = document.getElementById("speakerSelect");
    const micType = document.getElementById("micType");
    const totalsBadge = document.getElementById("totalCount");
    const currentText = document.getElementById("currentText");
    const attemptsInfo = document.getElementById("attemptsInfo");
    const speakerStats = document.getElementById("speakerStats");
    const vuBar = document.getElementById("vu");
    const micStatus = document.getElementById("micStatus");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const saveStatus = document.getElementById("saveStatus");
    const overlay = document.getElementById("overlay");
    const countNum = document.getElementById("countNum");
    const preview = document.getElementById("preview");
    const progressBar = document.getElementById("progressBar");

    // === Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ===
    let audioCtx, mediaStream, sourceNode, hpFilter, lpFilter, compressor, analyser, dest, recorder;
    let chunks = [];
    let recordingBlob = null;
    let activeSpeaker = null;
    let activeText = null;
    let rafId = null;

    // === Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const uuid = ()=>crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"-"+Math.random().toString(16).slice(2));
    function fmtDateStamp(){
      const d = new Date();
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    // ØªÙˆÙ„ÙŠØ¯ ØµÙØ§Ø±Ø© Ù‚ØµÙŠØ±Ø©
    function beep(){
      if(!audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine"; o.frequency.value = 880;
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.4, audioCtx.currentTime+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.15);
      o.connect(g).connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime+0.16);
    }

    // Ø´Ø±ÙŠØ· VU
    function startMeter(){
      const buffer = new Uint8Array(128);
      function tick(){
        if(!analyser){ vuBar.style.width="0%"; return; }
        analyser.getByteTimeDomainData(buffer);
        // Ø­Ø³Ø§Ø¨ RMS Ø¨Ø³ÙŠØ·
        let sum=0; for(const v of buffer){ const x=(v-128)/128; sum+=x*x; }
        const rms = Math.sqrt(sum/buffer.length);
        const pct = Math.min(100, Math.max(0, Math.round(rms*160))); // ØªØ¶Ø®ÙŠÙ… Ø®ÙÙŠÙ
        vuBar.style.width = pct + "%";
        rafId = requestAnimationFrame(tick);
      }
      cancelAnimationFrame(rafId); tick();
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† + Ø³Ù„Ø³Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ù„Ù„ØµÙˆØª
    async function initMic(){
      micStatus.textContent = "Ø¬Ø§Ø±Ù ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†â€¦";
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({
          audio:{
            echoCancellation:true,
            noiseSuppression:true,
            autoGainControl:true,
            channelCount:1,
            sampleRate:48000
          },
          video:false
        });
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        sourceNode = audioCtx.createMediaStreamSource(mediaStream);

        // ÙÙ„ØªØ±Ø© Ø¨Ø³ÙŠØ·Ø© + Ø¶ØºØ· Ø®ÙÙŠÙ
        hpFilter = audioCtx.createBiquadFilter();
        hpFilter.type = "highpass"; hpFilter.frequency.value = 120; // Ù‚ØµÙ‘ Ø¶Ø¬ÙŠØ¬ Ù…Ù†Ø®ÙØ¶

        lpFilter = audioCtx.createBiquadFilter();
        lpFilter.type = "lowpass"; lpFilter.frequency.value = 8000; // Ù‚ØµÙ‘ Ø­Ø§Ø¯ ÙÙˆÙ‚ 8 ÙƒHz Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù‡Ø³

        compressor = audioCtx.createDynamicsCompressor();
        compressor.threshold.value = -24; compressor.knee.value = 20; compressor.ratio.value = 3;
        compressor.attack.value = 0.003; compressor.release.value = 0.25;

        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;

        dest = audioCtx.createMediaStreamDestination();

        // Ø§Ù„Ø³Ù„Ø³Ù„Ø©: Ù…ØµØ¯Ø± â†’ HP â†’ LP â†’ Compressor â†’ Analyser â†’ Destination
        sourceNode.connect(hpFilter).connect(lpFilter).connect(compressor).connect(analyser).connect(dest);

        // Ù…ÙØ³Ø¬Ù‘Ù„ Ù…Ù† stream Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬
        recorder = new MediaRecorder(dest.stream, { mimeType: "audio/webm" });

        recorder.ondataavailable = (e)=>{ if(e.data && e.data.size>0) chunks.push(e.data); };
        recorder.onstop = ()=>{
          recordingBlob = new Blob(chunks, { type: "audio/webm" });
          chunks = [];
          preview.src = URL.createObjectURL(recordingBlob);
          uploadBtn.classList.remove("disabled");
          stopBtn.classList.add("disabled");
          startBtn.classList.remove("disabled");
          saveStatus.textContent = "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø¢Ù† Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.";
        };

        micStatus.textContent = "Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª: Ø¬Ø§Ù‡Ø²";
        startBtn.classList.remove("disabled");
        startBtn.classList.add("glow");
        startMeter();
      }catch(err){
        console.error(err);
        micStatus.innerHTML = `<span class="error">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ${err.message}</span>`;
      }
    }

    // Ø§Ù„Ø¹Ø¯Ù‘ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ + Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    async function startRecording(){
      if(!recorder || !activeSpeaker || !activeText){ return; }
      startBtn.classList.add("disabled");
      uploadBtn.classList.add("disabled");
      saveStatus.textContent = "";

      // Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ + ØµÙØ§Ø±Ø§Øª
      overlay.style.display = "flex";
      for(let n=3;n>=1;n--){
        countNum.textContent = n;
        beep();
        await sleep(1000);
      }
      overlay.style.display = "none";

      // Ø¨Ø¯Ø¡
      recorder.start();
      stopBtn.classList.remove("disabled");
      startBtn.classList.remove("glow");
      saveStatus.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„â€¦ ØªØ­Ø¯Ø« Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.";
    }

    function stopRecording(){
      if(recorder && recorder.state === "recording"){
        recorder.stop();
      }
    }

    // Ø±ÙØ¹ + Ø¥Ø¯Ø±Ø§Ø¬ ØµÙ
    async function uploadRecording(){
      try{
        if(!recordingBlob) return;
        saveStatus.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹â€¦";
        const stamp = fmtDateStamp();
        const path = `spk-${activeSpeaker.id}/${stamp}/rec-${uuid()}.webm`;

        // Ø±ÙØ¹ Ø¥Ù„Ù‰ Ø§Ù„ØªØ®Ø²ÙŠÙ†
        const up = await db.storage.from(BUCKET).upload(path, recordingBlob, {
          cacheControl:"3600",
          upsert:false,
          contentType:"audio/webm"
        });
        if(up.error) throw up.error;

        // Ø¥Ø¯Ø±Ø§Ø¬ ÙÙŠ Ø¬Ø¯ÙˆÙ„ recordings
        const mic = (micType.value || "").trim() || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        const ins = await db.from("recordings").insert({
          speaker_id: activeSpeaker.id,
          text_id: activeText.id,
          storage_path: path,
          status: "pending",
          mic_type: mic
        }).select("id").single();
        if(ins.error) throw ins.error;

        saveStatus.innerHTML = `<span class="success">âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.</span> Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Øµ Ø¬Ø¯ÙŠØ¯â€¦`;
        uploadBtn.classList.add("disabled");
        recordingBlob = null;

        // Ø­Ø¯Ù‘Ø« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª + Ø§Ø¬Ù„Ø¨ Ù†ØµÙ‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§
        await Promise.all([loadTotals(), loadSpeakerStats(), loadAttempts(activeText.id)]);
        await loadRandomText();
      }catch(err){
        console.error(err);
        saveStatus.innerHTML = `<span class="error">ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ${err.message}</span>`;
      }
    }

    // === Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase ===
    async function loadSpeakers(){
      speakerSelect.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ­Ø¯Ø« â€”</option>`;
      const { data, error } = await db.from("speakers").select("id,name").order("name",{ascending:true});
      if(error){ speakerSelect.innerHTML += `<option disabled>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</option>`; return; }
      for(const s of data){ 
        const op = document.createElement("option");
        op.value = s.id; op.textContent = s.name;
        speakerSelect.appendChild(op);
      }
    }

    async function loadTotals(){
      const { count } = await db.from("recordings").select("*", { count:"exact", head:true });
      totalsBadge.textContent = count ?? 0;
    }

    async function loadRandomText(){
      // Ø§Ø¬Ù„Ø¨ Ù†ØµÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ø´ÙˆØ§Ø¦ÙŠÙ‹Ø§ (Ù…Ù† Ù„Ù‡Ø¬Ø© Ø§Ù„Ø®Ø±Ø·ÙˆÙ…/Ù…Ù…Ø²ÙˆØ¬Ø© Ø¶Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„). ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±Ø· Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…ÙˆØ¯ category.
      const { data, error } = await db
          .from("texts")
          .select("id, content, category")
          .limit(1)
          .order("random"); // ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù…ØªØ¯Ø§Ø¯ random()
      if(error || !data?.length){ 
        currentText.innerHTML = `<span class="error">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù†Øµ. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØµÙˆØµ.</span>`;
        activeText = null;
        startBtn.classList.add("disabled");
        return;
      }
      activeText = data[0];
      currentText.textContent = activeText.content;
      startBtn.classList.remove("disabled");
      startBtn.classList.add("glow");
      // ØªÙ‚Ø¯Ù‘Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ (ØµÙÙØ±)
      progressBar.style.width = "0%";
      await loadAttempts(activeText.id);
    }

    async function loadAttempts(textId){
      const { count } = await db.from("recordings")
        .select("*",{count:"exact", head:true})
        .eq("text_id", textId);
      attemptsInfo.textContent = `Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ: ${count ?? 0}`;
      // ØªÙ‚Ø¯ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù…Ù„Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… (Ø­Ø¯ Ø£Ø¹Ù„Ù‰ 5)
      const max = 5, pct = Math.min(100, Math.round(((count ?? 0)/max)*100));
      progressBar.style.width = pct + "%";
    }

    async function loadSpeakerStats(){
      if(!activeSpeaker){ speakerStats.textContent = "Ø³Ø¬Ù‘Ù„Øª Ø¨ØµÙˆØªÙƒ: â€” Ù…Ù„Ù"; return; }
      const { count } = await db.from("recordings")
        .select("*",{count:"exact", head:true})
        .eq("speaker_id", activeSpeaker.id);
      speakerStats.textContent = `Ø³Ø¬Ù‘Ù„Øª Ø¨ØµÙˆØªÙƒ: ${count ?? 0} Ù…Ù„Ù`;
    }

    // === Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===
    speakerSelect.addEventListener("change", async (e)=>{
      const id = e.target.value;
      if(!id){ activeSpeaker = null; startBtn.classList.add("disabled"); return; }
      activeSpeaker = { id: Number(id), name: e.target.selectedOptions[0].textContent };
      await loadSpeakerStats();
      if(activeText) startBtn.classList.remove("disabled");
    });

    startBtn.addEventListener("click", startRecording);
    stopBtn.addEventListener("click", stopRecording);
    uploadBtn.addEventListener("click", uploadRecording);

    // Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    (function wireButtons(){
      // ÙŠÙØ¹Ù‘Ù„/ÙŠØ¹Ø·Ù‘Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø­Ø³Ø¨ recorder.state
      setInterval(()=>{
        if(!recorder) return;
        stopBtn.classList.toggle("disabled", recorder.state!=="recording");
      }, 300);
    })();

    // === Ø¥Ù‚Ù„Ø§Ø¹ Ø§Ù„ØµÙØ­Ø© ===
    await loadSpeakers();
    await loadTotals();
    await loadRandomText();
    await initMic();
  </script>
</body>
</html>
