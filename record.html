<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª - Ù…Ù†ØµØ© ØµÙˆØªÙ†Ø§</title>
<style>
body {
  font-family: 'Cairo', sans-serif;
  background: #0b0b0b;
  color: #fff;
  text-align: center;
  margin: 0;
  padding: 40px 10px;
}
.container {
  max-width: 650px;
  margin: auto;
  background: #111;
  padding: 30px;
  border-radius: 18px;
  box-shadow: 0 0 35px rgba(0,255,200,0.1);
}
.logo {
  width: 100px;
  margin-bottom: 15px;
}
h1 {
  color: #00e0b6;
}
p { color: #ccc; }
select {
  padding: 10px;
  border-radius: 8px;
  border: none;
  margin: 10px;
  font-size: 16px;
}
button {
  padding: 12px 25px;
  border: none;
  border-radius: 12px;
  margin: 10px 5px;
  font-size: 16px;
  cursor: pointer;
  transition: 0.3s;
}
#startBtn { background: linear-gradient(90deg,#00e0b6,#00b4d8); color: #fff; }
#stopBtn { background: #ff4d4d; color: #fff; }
#uploadBtn { background: #666; color: #fff; }
button:hover { transform: scale(1.05); }
.text-box {
  background: #1a1a1a;
  padding: 15px;
  border-radius: 10px;
  margin-top: 20px;
}
#volumeBar {
  width: 100%;
  height: 10px;
  background: #222;
  border-radius: 6px;
  overflow: hidden;
  margin: 10px 0;
}
#volumeLevel {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg,#00e0b6,#00b4d8);
  transition: width 0.1s ease;
}
.status { font-size: 15px; color: #aaa; margin-top: 10px; }
.success { color: #00ff91; }
#countdown {
  font-size: 48px;
  color: #00e0b6;
  margin-top: 20px;
  display: none;
}
</style>
</head>
<body>
<div class="container">
  <img src="https://i.ibb.co/MhC1Qyc/mic-logo.png" class="logo" alt="Mic Logo" />
  <h1>ğŸ§ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª - Ù…Ù†ØµØ© ØµÙˆØªÙ†Ø§</h1>
  <p>Ù†ØµÙŠØ­Ø©: Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ ÙˆØ§Ø¶ØºØ· Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. Ø³ÙŠØ¸Ù‡Ø± Ø¹Ø¯Ù‘ ØªÙ†Ø§Ø²Ù„ÙŠ (3 Ø«ÙˆØ§Ù†Ù) Ù…Ø¹ ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠØŒ Ø«Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</p>

  <label>Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ:</label>
  <select id="speakerSelect">
    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ­Ø¯Ø« --</option>
  </select>
  <p id="speakerStats">...</p>

  <div class="text-box">
    <h3 style="color:#00e0b6;">Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ:</h3>
    <p id="recordText" style="font-size:18px;color:#fff;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµ...</p>
    <p id="recordCount" style="color:#aaa;">...</p>
  </div>

  <div id="volumeBar"><div id="volumeLevel"></div></div>
  <div class="status" id="volumeStatus">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª: Ø¬Ø§Ù‡Ø²</div>

  <div id="countdown">3</div>

  <button id="startBtn">âœï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
  <button id="stopBtn" disabled>â¹ï¸ Ø£ÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
  <button id="uploadBtn" disabled>â¬†ï¸ Ø§Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>

  <audio id="audioPlayer" controls style="display:none;margin-top:15px;"></audio>

  <p id="uploadStatus" class="success"></p>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm";

const supabase = createClient(
  "https://qcctqvmwwpsoiexgdqwp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3Rxdm13d3Bzb2lleGdkcXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI1OTcsImV4cCI6MjA3ODI5ODU5N30.uTfskCuzkZNcvy1QdaOzqlW8km-wcZQoVRFi6k2xndQ"
);
const BUCKET = "recordings";

let speakers = [];
let currentTextId = null;
let selectedSpeaker = null;
let mediaRecorder, audioChunks = [];
let audioContext, analyser, gainNode, source;
let animationFrame;

// ğŸµ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

// ğŸ§  ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªØ­Ø¯Ø«ÙŠÙ†
async function loadSpeakers() {
  const { data, error } = await supabase.from("speakers").select("id, name");
  if (error || !data) return alert("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ­Ø¯Ø«ÙŠÙ†");
  speakers = data;
  const select = document.getElementById("speakerSelect");
  data.forEach(sp => {
    const opt = document.createElement("option");
    opt.value = sp.id;
    opt.textContent = sp.name;
    select.appendChild(opt);
  });
}
loadSpeakers();

// Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØ­Ø¯Ø«
document.getElementById("speakerSelect").addEventListener("change", async (e) => {
  const id = e.target.value;
  if (!id) return;
  selectedSpeaker = id;
  const { data: recs } = await supabase.from("recordings").select("id").eq("speaker_id", id);
  document.getElementById("speakerStats").innerHTML =
    `ğŸ¤ Ù„Ù‚Ø¯ Ø³Ø¬Ù„Øª <b>${recs?.length || 0}</b> Ù…Ù„ÙÙ‹Ø§ Ø¨ØµÙˆØªÙƒ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.`;
  loadNewText();
});

// Ø¬Ù„Ø¨ Ù†Øµ Ø¹Ø´ÙˆØ§Ø¦ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§
async function loadNewText() {
  const { data, error } = await supabase
    .from("texts")
    .select("id, content")
    .limit(1)
    .order("random()");
  if (error || !data.length) {
    document.getElementById("recordText").textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØµÙˆØµ Ù…ØªØ§Ø­Ø©.";
    return;
  }
  currentTextId = data[0].id;
  document.getElementById("recordText").textContent = data[0].content;
  document.getElementById("recordCount").textContent = "Ø³Ø¬Ù„ Ø§Ù„Ù†Øµ Ø¨ÙˆØ¶ÙˆØ­.";
}

// ğŸ”¢ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
async function startCountdown() {
  const countdown = document.getElementById("countdown");
  countdown.style.display = "block";
  for (let i = 3; i > 0; i--) {
    countdown.textContent = i;
    beep.play();
    await new Promise(r => setTimeout(r, 1000));
  }
  countdown.style.display = "none";
  startRecording();
}

// ğŸ™ï¸ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
async function startRecording() {
  if (!selectedSpeaker || !currentTextId) {
    alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØ­Ø¯Ø« Ø£ÙˆÙ„Ù‹Ø§.");
    return;
  }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: { noiseSuppression: true, echoCancellation: true, autoGainControl: true }
    });

    audioContext = new AudioContext();
    source = audioContext.createMediaStreamSource(stream);
    gainNode = audioContext.createGain();
    gainNode.gain.value = 2.0;
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;

    source.connect(gainNode);
    gainNode.connect(analyser);
    const destination = audioContext.createMediaStreamDestination();
    gainNode.connect(destination);

    mediaRecorder = new MediaRecorder(destination.stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = saveRecording;

    mediaRecorder.start();
    visualizeVolume();
    document.getElementById("startBtn").disabled = true;
    document.getElementById("stopBtn").disabled = false;
    document.getElementById("volumeStatus").textContent = "ğŸ™ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";
  } catch (err) {
    alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†.");
  }
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== "inactive") {
    mediaRecorder.stop();
    cancelAnimationFrame(animationFrame);
    document.getElementById("stopBtn").disabled = true;
    document.getElementById("uploadBtn").disabled = false;
    document.getElementById("volumeStatus").textContent = "â¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„.";
  }
}

// ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø¤Ù‚ØªÙ‹Ø§
async function saveRecording() {
  const blob = new Blob(audioChunks, { type: "audio/webm" });
  const url = URL.createObjectURL(blob);
  const player = document.getElementById("audioPlayer");
  player.src = url;
  player.style.display = "block";
  document.getElementById("uploadBtn").onclick = () => uploadRecording(blob);
}

// â˜ï¸ Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
async function uploadRecording(blob) {
  const fileName = `speaker_${selectedSpeaker}_text_${currentTextId}_${Date.now()}.webm`;
  document.getElementById("uploadStatus").textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";
  const { error } = await supabase.storage.from(BUCKET).upload(fileName, blob);
  if (error) return alert("âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ");

  await supabase.from("recordings").insert([
    { speaker_id: selectedSpeaker, text_id: currentTextId, storage_path: fileName, status: "pending" }
  ]);
  document.getElementById("uploadStatus").textContent = "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!";
}

// ğŸ›ï¸ ØªØ­Ù„ÙŠÙ„ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª
function visualizeVolume() {
  const dataArray = new Uint8Array(analyser.frequencyBinCount);
  function draw() {
    analyser.getByteFrequencyData(dataArray);
    const avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
    const volume = Math.min(100, (avg / 128) * 100);
    document.getElementById("volumeLevel").style.width = volume + "%";
    const status = document.getElementById("volumeStatus");
    if (volume < 20) status.textContent = "ğŸ”ˆ Ø§Ù„ØµÙˆØª Ù…Ù†Ø®ÙØ¶";
    else if (volume > 80) status.textContent = "ğŸ“¢ Ø§Ù„ØµÙˆØª Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ù‹Ø§";
    else status.textContent = "ğŸ¤ Ø§Ù„ØµÙˆØª Ø¬ÙŠØ¯";
    animationFrame = requestAnimationFrame(draw);
  }
  draw();
}

document.getElementById("startBtn").addEventListener("click", startCountdown);
document.getElementById("stopBtn").addEventListener("click", stopRecording);
</script>
</body>
</html>
