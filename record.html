<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>ğŸ™ï¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ - ØµÙˆØªÙ†Ø§</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <img src="logo-full.png" class="logo" alt="ØµÙˆØªÙ†Ø§">
      <h2>ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª â€“ Ù…Ù†ØµØ© ØµÙˆØªÙ†Ø§</h2>
    </header>

    <section id="record-section">
      <label for="speaker">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ:</label>
      <select id="speaker"></select>

      <div id="textBox">
        <h3>Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ:</h3>
        <p id="currentText">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµ...</p>
      </div>

      <button id="recordBtn" class="btn">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
      <button id="stopBtn" class="btn" disabled>â¹ï¸ Ø£ÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
      <button id="uploadBtn" class="btn" disabled>â¬†ï¸ Ø§Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
      <p id="status"></p>
    </section>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm';
    const supabase = createClient(
      "https://qcctqvmwwpsoiexgdqwp.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3Rxdm13d3Bzb2lleGdkcXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI1OTcsImV4cCI6MjA3ODI5ODU5N30.uTfskCuzkZNcvy1QdaOzqlW8km-wcZQoVRFi6k2xndQ"
    );
    const BUCKET = "recordings";

    const speakerSelect = document.getElementById("speaker");
    const currentText = document.getElementById("currentText");
    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const status = document.getElementById("status");

    let recorder, chunks = [], audioBlob, currentTextId = null;

    // ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªØ­Ø¯Ø«ÙŠÙ†
    async function loadSpeakers() {
      const { data } = await supabase.from("speakers").select("id, name");
      speakerSelect.innerHTML = data.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØªØ§Ø­
    async function loadText() {
      const { data } = await supabase
        .from("texts")
        .select("id, content, record_count, max_recordings")
        .eq("status", "available")
        .order("record_count", { ascending: true })
        .limit(1)
        .single();

      if (!data) {
        currentText.textContent = "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØµÙˆØµ âœ…";
        recordBtn.disabled = true;
        return;
      }

      currentTextId = data.id;
      currentText.textContent = data.content;
    }

    // Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
    recordBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recorder = new MediaRecorder(stream);
      chunks = [];
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = () => {
        audioBlob = new Blob(chunks, { type: "audio/webm" });
        uploadBtn.disabled = false;
      };
      recorder.start();
      recordBtn.disabled = true;
      stopBtn.disabled = false;
      status.textContent = "ğŸ™ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";
    };

    stopBtn.onclick = () => {
      recorder.stop();
      recordBtn.disabled = false;
      stopBtn.disabled = true;
      status.textContent = "âœ… ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„.";
    };

    uploadBtn.onclick = async () => {
      const speakerId = speakerSelect.value;
      if (!speakerId || !audioBlob || !currentTextId) {
        alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù…Ùƒ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹.");
        return;
      }

      const fileName = `${speakerId}_${Date.now()}.webm`;
      status.textContent = "â¬†ï¸ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";
      const { error: uploadError } = await supabase.storage
        .from(BUCKET)
        .upload(fileName, audioBlob);

      if (uploadError) {
        status.textContent = "âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø±ÙØ¹.";
        return;
      }

      // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      await supabase.from("recordings").insert({
        speaker_id: speakerId,
        text_id: currentTextId,
        storage_path: fileName
      });

      // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Øµ
      await supabase.rpc("increment_record_count", { text_uuid: currentTextId });

      status.textContent = "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!";
      uploadBtn.disabled = true;
      loadText();
    };

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
    loadSpeakers();
    loadText();
  </script>
</body>
</html>
