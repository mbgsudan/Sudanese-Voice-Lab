
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª â€” ØµÙˆØªÙ†Ø§</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
<div class="container">
  <header class="header">
    <h1>ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª Ø¬Ø¯ÙŠØ¯ ğŸ™ï¸</h1>
    <p class="subtitle"><span class="counter" id="counter">0/0</span> â€” Ø§Ù‚Ø±Ø£ Ø§Ù„Ù†Øµ Ø¨ÙˆØ¶ÙˆØ­ ÙˆØ¨Ù„Ù‡Ø¬ØªÙƒ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ÙŠØ©.</p>
  </header>

  <section class="panel">
    <div class="grid cols-2">
      <div class="card">
        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ­Ø¯Ø«</label>
        <select id="speaker"></select>
      </div>
      <div class="card">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</label>
        <select id="mic">
          <option value="phone">Ù‡Ø§ØªÙ / Ù„Ø§Ø¨ØªÙˆØ¨</option>
          <option value="usb">USB Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</option>
        </select>
      </div>
    </div>

    <div class="card" id="textBox" style="min-height:140px">
      <h2 style="margin:0">Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ:</h2>
      <p id="text_content" style="font-size:28px;margin:6px 0 0"></p>
      <p class="small" id="text_meta"></p>
      <div class="row" style="justify-content:flex-end">
        <button class="btn btn-ghost" id="prev">âª Ù†Øµ Ø³Ø§Ø¨Ù‚</button>
        <button class="btn btn-ghost" id="skip">â­ï¸ ØªØ®Ø·ÙŠ Ø§Ù„Ù†Øµ</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center;justify-content:center">
        <button class="btn" id="recBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ğŸ™ï¸</button>
      </div>
      <div id="recState" class="center small" style="margin-top:10px;color:#9ab0b2">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ø¬ÙŠÙ„â€¦</div>
      <div id="player" style="margin-top:10px"></div>
    </div>
  </section>

  <footer class="footer">Â© ØµÙˆØªÙ†Ø§ 2025</footer>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm';
  import { SUPABASE_URL, SUPABASE_ANON_KEY, BUCKET } from './config.js';
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const el = s => document.querySelector(s);
  const speakerSel = el('#speaker');
  const counterEl = el('#counter');
  const textContent = el('#text_content');
  const textMeta = el('#text_meta');
  const recBtn = el('#recBtn');
  const recState = el('#recState');
  const player = el('#player');

  let texts = [], idx = 0, currentText = null, media, recorder, chunks = [];
  let speakers = [], currentSpeaker = null;

  async function loadSpeakers(){
    const { data, error } = await sb.from('speakers').select('id,name').order('name');
    if(error){ speakerSel.innerHTML = '<option>âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ­Ø¯Ø«ÙŠÙ†</option>'; return; }
    speakers = data || [];
    speakerSel.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ­Ø¯Ø« â€”</option>' + speakers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  }

  async function loadTexts(){
    const { data, error } = await sb.from('texts').select('id,content,domain').order('id');
    if(error || !data?.length){
      textContent.textContent = 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù†Øµ. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØµÙˆØµ.';
      return;
    }
    texts = data;
    idx = 0;
    renderText();
  }

  function renderText(){
    if(!texts.length){ return; }
    currentText = texts[idx];
    textContent.textContent = currentText.content;
    textMeta.textContent = currentText.domain ? 'Ø§Ù„Ù…Ø¬Ø§Ù„: ' + currentText.domain : '';
    counterEl.textContent = `${idx+1}/${texts.length}`;
  }

  el('#prev').onclick = ()=>{ idx = Math.max(0, idx-1); renderText(); };
  el('#skip').onclick = ()=>{ idx = Math.min(texts.length-1, idx+1); renderText(); };

  speakerSel.onchange = ()=>{
    const id = speakerSel.value;
    currentSpeaker = speakers.find(s=> String(s.id) === String(id));
  };

  async function startRec(){
    if(!currentSpeaker){ alert('Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹'); return; }
    if(!currentText){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ'); return; }
    try{
      media = await navigator.mediaDevices.getUserMedia({ audio:true });
      recorder = new MediaRecorder(media, { mimeType:'audio/webm' });
      chunks = [];
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = onStop;
      recorder.start();
      recState.textContent = 'â— Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„â€¦ Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ù„Ø¥ÙŠÙ‚Ø§ÙÙ‡';
      recBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â¹ï¸';
    }catch(err){
      alert('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†');
    }
  }

  async function stopRec(){
    recorder?.stop();
    media?.getTracks().forEach(t=>t.stop());
    recState.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸â€¦';
    recBtn.disabled = true;
  }

  async function onStop(){
    const blob = new Blob(chunks, { type:'audio/webm' });
    const fileName = `rec_${currentSpeaker.id}_${currentText.id}_${Date.now()}.webm`;
    // upload to storage
    const { error:upErr } = await sb.storage.from(BUCKET).upload(fileName, blob, { upsert:false, contentType:'audio/webm' });
    if(upErr){ alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù'); recState.textContent='Ø­Ø¯Ø« Ø®Ø·Ø£.'; recBtn.disabled=false; recBtn.textContent='Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ğŸ™ï¸'; return; }

    // insert row
    const { error:dbErr } = await sb.from('recordings').insert({
      speaker_id: currentSpeaker.id,
      text_id: currentText.id,
      mic_type: el('#mic').value,
      storage_path: fileName,
      status: 'pending'
    });
    if(dbErr){ alert('ØªÙ… Ø§Ù„Ø±ÙØ¹ Ù„ÙƒÙ† ÙØ´Ù„ Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø³Ø¬Ù„'); }

    // player preview
    const url = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${fileName}`;
    player.innerHTML = `<audio controls src="${url}"></audio>`;
    recState.textContent = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ.';
    recBtn.disabled = false;
    recBtn.textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ğŸ™ï¸';
  }

  recBtn.onclick = () => {
    if(!recorder || recorder.state==='inactive') startRec(); else stopRec();
  };

  loadSpeakers();
  loadTexts();
</script>
</body>
</html>
