<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª - ØµÙˆØªÙ†Ø§</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;700&display=swap" rel="stylesheet"/>
  <style>
    body{font-family:'Cairo',sans-serif;background:radial-gradient(circle at top,#0d1b1e,#000);color:#fff;text-align:center;margin:0}
    h1{margin:28px 0 10px;color:#00e0b6;text-shadow:0 0 10px rgba(0,224,182,.4)}
    .container{max-width:640px;margin:16px auto 40px;background:#0f1518;padding:20px;border-radius:16px;box-shadow:0 0 25px rgba(0,0,0,.45)}
    .meta{opacity:.8;font-size:14px;margin-bottom:10px}
    .text-box{background:#1a1f21;border-radius:12px;padding:16px;font-size:18px;line-height:1.7;margin-bottom:16px;min-height:92px}
    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .btn{background:linear-gradient(90deg,#00e0b6,#00b4d8);border:none;color:#001b1f;padding:12px 22px;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;transition:.25s}
    .btn:hover{opacity:.9;transform:translateY(-1px)}
    .btn-danger{background:#ff4d4d;color:#fff}
    .btn-ghost{background:#1a1f21;color:#cfe;box-shadow:inset 0 0 0 1px #2a2f31}
    audio{width:100%;margin-top:10px;border-radius:10px}
    #statusMsg{margin-top:12px;color:#00ffa3;font-size:14px;min-height:20px}
    .muted{color:#97a0a2}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <h1>ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª Ø¬Ø¯ÙŠØ¯</h1>
  <div class="container">
    <div class="meta">
      <span id="counter" class="muted">0/â€”</span>
      <span class="muted">â€¢</span>
      <span id="hint" class="muted">Ø§Ù‚Ø±Ø£ Ø§Ù„Ù†Øµ Ø¨ÙˆØ¶ÙˆØ­ ÙˆØ¨Ø·Ø¨Ø¹ØªÙƒ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ÙŠØ© ğŸ‘Œ</span>
    </div>

    <div class="text-box">
      <b>Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ:</b>
      <p id="recordText" style="margin:.4rem 0 0">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµâ€¦</p>
    </div>

    <div class="row" style="margin:6px 0 8px">
      <button id="btnPrev" class="btn btn-ghost">â®ï¸ Ù†Øµ Ø³Ø§Ø¨Ù‚</button>
      <button id="btnSkip" class="btn btn-ghost">â­ï¸ ØªØ®Ø·Ù‘ÙŠ Ø§Ù„Ù†Øµ</button>
    </div>

    <div class="row" style="margin-top:6px">
      <button id="startBtn" class="btn">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
      <button id="stopBtn"  class="btn btn-danger hidden">â¹ï¸ Ø£ÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    </div>

    <audio id="audioPreview" controls class="hidden"></audio>

    <div class="row" style="margin-top:8px">
      <button id="uploadBtn" class="btn hidden">ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
      <button id="redoBtn" class="btn btn-ghost hidden">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    </div>

    <p id="statusMsg"></p>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm";

    // Supabase
    const supabase = createClient(
      "https://qcctqvmwwpsoiexgdqwp.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3Rxdm13d3Bzb2lleGdkcXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI1OTcsImV4cCI6MjA3ODI5ODU5N30.uTfskCuzkZNcvy1QdaOzqlW8km-wcZQoVRFi6k2xndQ"
    );

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const recordText = document.getElementById("recordText");
    const counterEl  = document.getElementById("counter");
    const startBtn   = document.getElementById("startBtn");
    const stopBtn    = document.getElementById("stopBtn");
    const uploadBtn  = document.getElementById("uploadBtn");
    const redoBtn    = document.getElementById("redoBtn");
    const btnSkip    = document.getElementById("btnSkip");
    const btnPrev    = document.getElementById("btnPrev");
    const audioEl    = document.getElementById("audioPreview");
    const statusMsg  = document.getElementById("statusMsg");

    // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    let mediaRecorder, chunks = [], blob = null;

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…ØªØªØ§Ø¨Ø¹Ø©
    const USED_KEY = "sawtna_used_text_ids";   // IDs Ø§Ù„ØªÙŠ Ø§Ø³ØªÙØ®Ø¯Ù…Øª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²
    const SEEN_KEY = "sawtna_seen_history";    // Ù…Ø³Ø§Ø± Ù„Ù„ØªØ±Ø§Ø¬Ø¹ (Prev)

    let currentText = null;
    let usedIds = new Set(JSON.parse(localStorage.getItem(USED_KEY) || "[]"));
    let history  = JSON.parse(localStorage.getItem(SEEN_KEY) || "[]"); // [{id, content}]
    let totalCount = "â€”";

    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØµÙˆØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    async function fetchCounts() {
      const { count } = await supabase.from("texts").select("*", { count: "estimated", head: true });
      if (typeof count === "number") totalCount = count;
      renderCounter();
    }
    function renderCounter() {
      counterEl.textContent = `${usedIds.size}/${totalCount}`;
    }

    // Ø¬Ù„Ø¨ Ù†Øµ ÙˆØ§Ø­Ø¯ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²
    async function fetchNextText() {
      // Ù„Ùˆ Ø¹Ù†Ø¯Ù†Ø§ ID ÙƒØ«ÙŠØ±Ø© Ù‚Ø¯ ØªØªØ®Ø·Ù‰ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø› Ù„Ø°Ù„Ùƒ Ù†Ø£Ø®Ø° Ø¢Ø®Ø± 200 ÙÙ‚Ø· Ù„Ù„ØªØµÙÙŠØ©
      const ignore = Array.from(usedIds).slice(-200);
      let q = supabase.from("texts").select("id, content").limit(1);
      if (ignore.length) q = q.not("id", "in", `(${ignore.join(",")})`);

      const { data, error } = await q;
      if (error) {
        recordText.textContent = "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµ.";
        return;
      }
      if (!data || !data.length) {
        recordText.textContent = "âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø². Ø´ÙƒØ±Ù‹Ø§ Ù„Ù…Ø³Ø§Ù‡Ù…ØªÙƒ!";
        startBtn.classList.add("hidden");
        btnSkip.classList.add("hidden");
        uploadBtn.classList.add("hidden");
        redoBtn.classList.add("hidden");
        return;
      }

      currentText = data[0];
      recordText.textContent = currentText.content;
      renderCounter();
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Øµ Ø§Ù„Ø³Ø§Ø¨Ù‚ (ØªØ±Ø§Ø¬Ø¹ Ø®Ø·ÙˆØ©)
    function showPrev() {
      if (!history.length) return;
      const prev = history.pop();               // Ø¢Ø®Ø± Ø¹Ù†ØµØ±
      // Ù„Ø§ Ù†Ø²ÙŠÙ„Ù‡ Ù…Ù† usedIds Ø­ØªÙ‰ Ù„Ø§ ÙŠÙØ¹Ø§Ø¯ Ø¹Ø±Ø¶Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
      currentText = prev;
      recordText.textContent = prev.content;
      localStorage.setItem(SEEN_KEY, JSON.stringify(history));
      statusMsg.textContent = "â†©ï¸ ØªÙ… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù†Øµ Ø§Ù„Ø³Ø§Ø¨Ù‚.";
      resetRecordingUI();
    }

    // ØªØ®Ø·Ù‘ÙŠ Ø§Ù„Ù†Øµ: Ù†Ø¯ÙØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„ØªØ§Ø±ÙŠØ® ÙˆÙ†Ø·Ù„Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ (ÙˆÙ„Ø§ Ù†Ø¶ÙŠÙÙ‡ Ù„Ù€ usedIds)
    async function skipText() {
      if (!currentText) return;
      history.push(currentText);
      localStorage.setItem(SEEN_KEY, JSON.stringify(history));
      statusMsg.textContent = "â­ï¸ ØªÙ… ØªØ®Ø·Ù‘ÙŠ Ø§Ù„Ù†Øµ.";
      resetRecordingUI();
      await fetchNextText();
    }

    // Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ù†Ø§Ø¬Ø­: Ø£Ø¶Ù ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‚Ø§Ø¦Ù…Ø© used ÙˆØ§Ø­Ø¶Ø± Ø§Ù„ØªØ§Ù„ÙŠ
    function markUsed(id) {
      usedIds.add(id);
      localStorage.setItem(USED_KEY, JSON.stringify(Array.from(usedIds)));
      renderCounter();
    }

    // Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    startBtn.onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];
        mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
        mediaRecorder.onstop = () => {
          blob = new Blob(chunks, { type: "audio/webm" });
          audioEl.src = URL.createObjectURL(blob);
          audioEl.classList.remove("hidden");
          uploadBtn.classList.remove("hidden");
          redoBtn.classList.remove("hidden");
        };
        mediaRecorder.start();
        startBtn.classList.add("hidden");
        stopBtn.classList.remove("hidden");
        statusMsg.textContent = "ğŸ§ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„â€¦ ØªÙƒÙ„Ù… Ø¨Ø«Ø¨Ø§Øª Ù‚Ø±Ø¨ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†";
      } catch {
        statusMsg.textContent = "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.";
      }
    };

    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
      stopBtn.classList.add("hidden");
      startBtn.classList.remove("hidden");
      statusMsg.textContent = "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª. Ø§Ø³ØªÙ…Ø¹ Ø«Ù… Ø§Ø±ÙØ¹Ù‡.";
    };

    redoBtn.onclick = () => {
      blob = null;
      audioEl.classList.add("hidden");
      uploadBtn.classList.add("hidden");
      redoBtn.classList.add("hidden");
      statusMsg.textContent = "ğŸ” Ø£Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²Ù‹Ø§.";
    };

    uploadBtn.onclick = async () => {
      if (!blob || !currentText) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø§Ù‡Ø²!");
      statusMsg.textContent = "ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹â€¦";

      // 1) Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„ØªØ®Ø²ÙŠÙ†
      const name = `rec_${Date.now()}.webm`;
      const { error: upErr } = await supabase.storage.from("recordings").upload(name, blob);
      if (upErr) { statusMsg.textContent = "âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù."; return; }

      // 2) Ø¥Ø¯Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ±Ø¨Ø· Ø§Ù„Ù†Øµ
      const { error: insErr } = await supabase.from("recordings").insert([{
        storage_path: name,
        status: "pending",
        text_id: currentText.id
      }]);
      if (insErr) { statusMsg.textContent = "âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."; return; }

      // 3) Ø¹Ù„Ù‘Ù… Ø§Ù„Ù†Øµ ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¶Ø± Ø§Ù„ØªØ§Ù„ÙŠ
      markUsed(currentText.id);
      history.push(currentText);
      localStorage.setItem(SEEN_KEY, JSON.stringify(history));

      statusMsg.textContent = "âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ø¥Ø­Ø¶Ø§Ø± Ù†Øµ Ø¬Ø¯ÙŠØ¯â€¦";
      resetRecordingUI();
      await fetchNextText();
    };

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
    btnSkip.onclick = skipText;
    btnPrev.onclick = showPrev;

    // ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ù„ØµÙˆØª Ø§Ù„ØªØ§Ù„ÙŠ
    function resetRecordingUI() {
      blob = null;
      audioEl.classList.add("hidden");
      uploadBtn.classList.add("hidden");
      redoBtn.classList.add("hidden");
      stopBtn.classList.add("hidden");
      startBtn.classList.remove("hidden");
    }

    // Ø¨Ø¯Ø§ÙŠØ©
    fetchCounts();
    await fetchNextText();
  </script>
</body>
</html>
