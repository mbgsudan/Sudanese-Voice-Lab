<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© - ØµÙˆØªÙ†Ø§</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --bg:#0b0b0b; --panel:#111; --muted:#9aa3a9; --text:#eaf2f4;
    --brand:#00e0c6; --brand2:#00b4d8; --ok:#00c97a; --warn:#ffb703; --err:#ff4d4d;
  }
  body { font-family:"Cairo", system-ui, sans-serif; background:var(--bg); color:var(--text); margin:0; }
  .wrap { max-width:1000px; margin:40px auto; background:var(--panel); padding:30px; border-radius:20px; box-shadow:0 0 40px rgba(0,0,0,.45); }
  header { display:flex; align-items:center; justify-content:center; gap:14px; margin-bottom:25px; flex-wrap:wrap; }
  header img { height:60px; width:auto; border-radius:12px; }
  h1 { color:var(--brand); margin:0; text-align:center; }
  .stats { display:grid; grid-template-columns:repeat(auto-fit, minmax(160px,1fr)); gap:14px; margin-top:20px; }
  .card { background:#1a1d1f; border-radius:14px; padding:18px; text-align:center; box-shadow:0 0 8px rgba(0,0,0,.3); }
  .card h3 { margin:4px 0; font-size:18px; color:var(--muted); }
  .card p { margin:4px 0; font-size:28px; font-weight:bold; color:var(--brand2); }
  canvas { margin-top:25px; width:100%!important; height:320px!important; }
  .note { text-align:center; color:var(--muted); margin-top:20px; font-size:13px; }
  table{width:100%;border-collapse:collapse;margin-top:25px;font-size:15px}
  th,td{border-bottom:1px solid #222;padding:10px;text-align:right}
  th{color:var(--brand2);font-weight:600}
  audio{width:180px}
  .status{font-weight:600}
  .approved{color:var(--ok)}
  .rejected{color:var(--err)}
  .pending{color:var(--warn)}
</style>
</head>
<body>

<div class="wrap">
  <header>
    <img src="logo-full.png" alt="Ø´Ø¹Ø§Ø± ØµÙˆØªÙ†Ø§" />
    <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø´Ø±ÙˆØ¹ ØµÙˆØªÙ†Ø§</h1>
  </header>

  <div class="stats">
    <div class="card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</h3><p id="totalRecs">â€”</p></div>
    <div class="card"><h3>Ø§Ù„Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ âœ…</h3><p id="approved">â€”</p></div>
    <div class="card"><h3>Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø© âŒ</h3><p id="rejected">â€”</p></div>
    <div class="card"><h3>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ğŸ•“</h3><p id="pending">â€”</p></div>
    <div class="card"><h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ­Ø¯Ø«ÙŠÙ† ğŸ¤</h3><p id="speakers">â€”</p></div>
    <div class="card"><h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØµÙˆØµ ğŸ“œ</h3><p id="texts">â€”</p></div>
  </div>

  <canvas id="chart"></canvas>

  <h2 style="margin-top:40px;color:var(--brand2)">ğŸ—‚ï¸ Ø¢Ø®Ø± 10 ØªØ³Ø¬ÙŠÙ„Ø§Øª</h2>
  <table id="recentTable">
    <thead>
      <tr><th>Ø§Ù„Ù…ØªØ­Ø¯Ø«</th><th>Ø§Ù„Ù†Øµ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØµÙˆØª</th></tr>
    </thead>
    <tbody><tr><td colspan="4" class="note">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
  </table>

  <p class="note">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙƒÙ„ 60 Ø«Ø§Ù†ÙŠØ©</p>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm";

const supabase = createClient(
  "https://qcctqvmwwpsoiexgdqwp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3Rxdm13d3Bzb2lleGdkcXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI1OTcsImV4cCI6MjA3ODI5ODU5N30.uTfskCuzkZNcvy1QdaOzqlW8km-wcZQoVRFi6k2xndQ"
);
const BUCKET="recordings";

const ids = (n) => document.getElementById(n);

async function loadStats(){
  try{
    const { data: recs } = await supabase.from("recordings").select("status");
    const { count: speakersCount } = await supabase.from("speakers").select("*", { count:"exact", head:true });
    const { count: textsCount } = await supabase.from("texts").select("*", { count:"exact", head:true });

    const total = recs.length;
    const approved = recs.filter(r=>r.status==="approved").length;
    const rejected = recs.filter(r=>r.status==="rejected").length;
    const pending  = recs.filter(r=>!r.status || r.status==="pending").length;

    ids("totalRecs").textContent = total;
    ids("approved").textContent = approved;
    ids("rejected").textContent = rejected;
    ids("pending").textContent  = pending;
    ids("speakers").textContent = speakersCount || 0;
    ids("texts").textContent    = textsCount || 0;

    updateChart(approved, rejected, pending);
  }catch(e){
    console.error(e);
  }
}

/* ===== Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ===== */
let chart;
function updateChart(approved, rejected, pending){
  const ctx=document.getElementById("chart").getContext("2d");
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:"doughnut",
    data:{
      labels:["Ù…ÙˆØ§ÙÙ‚","Ù…Ø±ÙÙˆØ¶","Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"],
      datasets:[{
        data:[approved, rejected, pending],
        backgroundColor:["#00c97a","#ff4d4d","#ffb703"],
        borderColor:"#0b0b0b",
        borderWidth:2
      }]
    },
    options:{
      plugins:{ legend:{ labels:{ color:"#eee", font:{family:"Cairo"} } } },
      animation:{ animateRotate:true, duration:800 }
    }
  });
}

/* ===== Ø¢Ø®Ø± 10 ØªØ³Ø¬ÙŠÙ„Ø§Øª ===== */
async function loadRecent(){
  const table=document.querySelector("#recentTable tbody");
  table.innerHTML="<tr><td colspan='4' class='note'>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>";

  const { data, error } = await supabase
    .from("recordings")
    .select("status, storage_path, speakers(name), texts(content)")
    .order("created_at",{ascending:false})
    .limit(10);

  if(error){ table.innerHTML="<tr><td colspan='4'>âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>"; return; }
  if(!data.length){ table.innerHTML="<tr><td colspan='4' class='note'>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯</td></tr>"; return; }

  table.innerHTML="";
  for(const r of data){
    const audioUrl = `${supabase.supabaseUrl}/storage/v1/object/public/${BUCKET}/${r.storage_path}`;
    const shortText = r.texts?.content ? r.texts.content.slice(0,40)+"..." : "â€”";
    const statusClass = r.status==="approved"?"approved":r.status==="rejected"?"rejected":"pending";
    const statusText = r.status==="approved"?"Ù…ÙˆØ§ÙÙ‚":r.status==="rejected"?"Ù…Ø±ÙÙˆØ¶":"Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.speakers?.name||"â€”"}</td>
      <td>${shortText}</td>
      <td class="status ${statusClass}">${statusText}</td>
      <td><audio controls src="${audioUrl}"></audio></td>
    `;
    table.appendChild(tr);
  }
}

/* ===== ØªØ´ØºÙŠÙ„ ===== */
await loadStats();
await loadRecent();
setInterval(()=>{loadStats(); loadRecent();}, 60000);
</script>
</body>
</html>
