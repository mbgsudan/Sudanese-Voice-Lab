<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª â€“ ØµÙˆØªÙ†Ø§</title>
<style>
  :root{
    --bg:#0b0b0b; --panel:#111; --muted:#9aa3a9; --text:#eaf2f4; --brand:#00e0c6; --ok:#00c97a; --err:#ff4d4d;
  }
  body{font-family:"Cairo", system-ui, -apple-system, Arial; background:var(--bg); color:var(--text); margin:0}
  .wrap{max-width:1100px;margin:40px auto;background:var(--panel);padding:26px;border-radius:20px;box-shadow:0 0 36px rgba(0,0,0,.45)}
  h1{margin:0 0 8px; color:var(--brand); text-align:center}
  .login{max-width:420px;margin:90px auto;text-align:center}
  input[type=password], input[type=text]{width:100%;background:#161a1b;color:var(--text);border:1px solid #222;border-radius:12px;padding:12px}
  button{border:0;border-radius:12px;padding:10px 16px;cursor:pointer}
  .btn{background:#2a2f32;color:var(--text)}
  .btn-green{background:#2d6a4f}
  .btn-red{background:#a11}
  table{width:100%;border-collapse:collapse;margin-top:16px}
  th,td{border-bottom:1px solid #222;padding:10px;vertical-align:middle}
  audio{width:220px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tools{display:flex;gap:10px;justify-content:center;margin:10px 0}
  .muted{color:var(--muted)}
</style>
</head>
<body>

<div id="gate" class="login">
  <h1>ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹</h1>
  <p class="muted">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.</p>
  <input id="pwd" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" />
  <div style="margin-top:10px"><button id="go" class="btn">Ø¯Ø®ÙˆÙ„</button></div>
  <p class="muted" style="margin-top:12px">ØªÙ„Ù…ÙŠØ­: ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø¬Ù„Ø³Ø© Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø¤Ù‚ØªÙ‹Ø§.</p>
</div>

<div id="app" class="wrap" style="display:none">
  <h1>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</h1>

  <div class="tools">
    <input id="newSpeaker" type="text" placeholder="Ø§Ø³Ù… Ù…ØªØ­Ø¯Ø« Ø¬Ø¯ÙŠØ¯" style="min-width:260px" />
    <button id="addSpk" class="btn">â• Ø¥Ø¶Ø§ÙØ© Ù…ØªØ­Ø¯Ø«</button>
    <button id="logout" class="btn-red">Ø®Ø±ÙˆØ¬</button>
  </div>

  <table id="tbl">
    <thead>
      <tr><th>Ø§Ù„Ù…ØªØ­Ø¯Ø«</th><th>Ø§Ù„Ù†Øµ</th><th>Ø§Ù„ØµÙˆØª</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
    </thead>
    <tbody id="tbody"><tr><td colspan="5" class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr></tbody>
  </table>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm";
const SUPABASE_URL="https://qcctqvmwwpsoiexgdqwp.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3Rxdm13d3Bzb2lleGdkcXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI1OTcsImV4cCI6MjA3ODI5ODU5N30.uTfskCuzkZNcvy1QdaOzqlW8km-wcZQoVRFi6k2xndQ";
const BUCKET="recordings";
const db=createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/* ===== Ø¨ÙˆØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ===== */
const PASS="70003mbgz"; // ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª
const gate=document.getElementById("gate");
const app=document.getElementById("app");
const go=document.getElementById("go");
const pwd=document.getElementById("pwd");
const logout=document.getElementById("logout");

function enter(){
  if(pwd.value===PASS){ sessionStorage.setItem("rv-ok","1"); gate.style.display="none"; app.style.display="block"; loadRecs(); }
  else alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
}
go.onclick=enter;
pwd.addEventListener("keydown",e=>{ if(e.key==="Enter") enter(); });

if(sessionStorage.getItem("rv-ok")==="1"){ gate.style.display="none"; app.style.display="block"; loadRecs(); }

logout.onclick=()=>{ sessionStorage.removeItem("rv-ok"); location.reload(); };

/* ===== Ø¹Ø±Ø¶ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª ===== */
const tbody=document.getElementById("tbody");

async function loadRecs(){
  tbody.innerHTML = `<tr><td colspan="5" class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>`;
  const { data, error } = await db.from("recordings")
    .select("id, status, storage_path, speakers(name), texts(content)")
    .order("created_at", { ascending:false })
    .limit(300);
  if(error){ tbody.innerHTML = `<tr><td colspan="5">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>`; return; }
  if(!data?.length){ tbody.innerHTML = `<tr><td colspan="5" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª.</td></tr>`; return; }

  tbody.innerHTML="";
  for(const r of data){
    const tr=document.createElement("tr");
    const audioUrl = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${r.storage_path}`;
    tr.innerHTML = `
      <td>${r.speakers?.name||"â€”"}</td>
      <td>${r.texts?.content||"â€”"}</td>
      <td><audio controls src="${audioUrl}"></audio></td>
      <td>${r.status||"pending"}</td>
      <td class="row">
        <button class="btn-green" data-act="ok" data-id="${r.id}">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
        <button class="btn-red" data-act="no" data-id="${r.id}">âŒ Ø±ÙØ¶</button>
      </td>`;
    tbody.appendChild(tr);
  }
}

tbody.addEventListener("click", async e=>{
  const btn=e.target.closest("button"); if(!btn) return;
  const id=Number(btn.dataset.id); if(!id) return;
  const act=btn.dataset.act;
  btn.disabled=true;
  try{
    const status = act==="ok" ? "approved" : "rejected";
    const { error } = await db.from("recordings").update({ status }).eq("id", id);
    if(error) throw error;
    await loadRecs();
  }catch(err){ alert("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«"); console.error(err); }
  finally{ btn.disabled=false; }
});

/* ===== Ø¥Ø¶Ø§ÙØ© Ù…ØªØ­Ø¯Ø« Ø³Ø±ÙŠØ¹ ===== */
document.getElementById("addSpk").onclick = async ()=>{
  const name = document.getElementById("newSpeaker").value.trim();
  if(!name){ alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ­Ø¯Ø«"); return; }
  const code = "SPK-" + Math.floor(100 + Math.random()*900);
  const { error } = await db.from("speakers").insert({ name, code });
  if(error){ alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); return; }
  document.getElementById("newSpeaker").value="";
  alert("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ­Ø¯Ø«");
};
</script>
</body>
</html>
