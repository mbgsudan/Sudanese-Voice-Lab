<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª | ØµÙˆØªÙ†Ø§</title>
  <link rel="stylesheet" href="styles.css">
  <script src="config.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const supabase = createClient(window.SAWTNA.SUPABASE_URL, window.SAWTNA.SUPABASE_ANON);
    if(!localStorage.getItem('admin_auth')) location.replace('admin.html');

    document.addEventListener('DOMContentLoaded', load);
    async function load(){
      const list = document.getElementById('list');
      list.innerHTML = '<div class="meta">â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
      const { data, error } = await supabase
        .from('recordings')
        .select(`id, status, storage_path, created_at, speakers(name, gender, age_range, accent), texts(content)`)
        .order('created_at', { ascending:false });
      if(error){ list.innerHTML = `<p class="msg-error">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>`; return; }
      if(!data.length){ list.innerHTML = `<p class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯.</p>`; return; }

      list.innerHTML = '';
      for(const r of data){
        const name = r.speakers?.name ?? 'Ù…Ø¬Ù‡ÙˆÙ„';
        const gender = r.speakers?.gender ?? 'â€”';
        const age = r.speakers?.age_range ?? 'â€”';
        const accent = r.speakers?.accent ?? 'â€”';
        const text = r.texts?.content ?? 'â€”';
        const badge = r.status === 'approved' ? 'ok' : r.status === 'rejected' ? 'reject' : 'pending';
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <strong>${name}</strong>
            <span class="badge ${badge}">Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status}</span>
          </div>
          <div class="meta">ğŸ‘¤ ${gender} | ğŸ‚ ${age} | ğŸ—£ï¸ ${accent}</div>
          <div class="meta">ğŸ’¬ ${text}</div>
          <div class="hr"></div>
          <audio controls src="${window.SAWTNA.SUPABASE_URL}/storage/v1/object/public/${window.SAWTNA.BUCKET}/${r.storage_path}"></audio>
          <div class="row" style="margin-top:10px">
            <button class="btn" style="background:#32d399;color:#001a12" data-act="approved">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
            <button class="btn danger" data-act="rejected">âŒ Ø±ÙØ¶</button>
          </div>
        `;
        div.querySelectorAll('button').forEach(b => {
          b.onclick = async () => {
            const status = b.dataset.act;
            const { error } = await supabase.from('recordings').update({ status }).eq('id', r.id);
            if(error) return alert('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
            div.querySelector('.badge').textContent = `Ø§Ù„Ø­Ø§Ù„Ø©: ${status}`;
            div.querySelector('.badge').className = 'badge ' + (status==='approved'?'ok':status==='rejected'?'reject':'pending');
          };
        });
        list.appendChild(div);
      }
    }

    window.logout = ()=>{ localStorage.removeItem('admin_auth'); location.href = 'admin.html'; };
  </script>
</head>
<body>
  <div class="container">
    <h1>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</h1>
    <header class="nav">
      <a href="index.html" class="link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ğŸ </a>
      <button class="btn danger" onclick="logout()">Ø®Ø±ÙˆØ¬ ğŸšª</button>
    </header>
    <div id="list"></div>
  </div>
</body>
</html>
