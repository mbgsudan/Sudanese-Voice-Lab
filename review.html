<script>
if (!localStorage.getItem("admin_auth")) {
  alert("ğŸ” ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
  window.location.href = "admin.html";
}
</script>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª - ØµÙˆØªÙ†Ø§</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: "Cairo", sans-serif;
  background: radial-gradient(circle at top, #0d1b1e, #000);
  color: #fff;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 1050px;
  margin: 20px auto;
  padding: 20px;
}
h1 {
  text-align: center;
  color: #00e0b6;
  margin-bottom: 25px;
  text-shadow: 0 0 15px rgba(0, 224, 198, 0.3);
}
.topbar {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 15px;
}
.btn {
  padding: 10px 18px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}
.add { background: linear-gradient(90deg, #00e0b6, #00b4d8); color: #fff; }
.logout { background: #ff4d4d; color: #fff; }
.logout:hover { background: #ff6666; }

#statsBar {
  display: flex;
  justify-content: space-around;
  background: #0f1518;
  border: 1px solid #00e0b6;
  border-radius: 14px;
  padding: 10px;
  margin-bottom: 20px;
  text-align: center;
}
#statsBar div {
  flex: 1;
  color: #ccc;
  font-size: 15px;
}
#statsBar span {
  display: block;
  font-size: 22px;
  font-weight: bold;
}
.approved { color: #00ff88; }
.rejected { color: #ff5555; }
.pending { color: #ffaa33; }

.card {
  background: #0f1314;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 18px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  transition: transform .2s ease;
}
.card:hover { transform: translateY(-3px); }
.status { font-size: 14px; margin-bottom: 5px; }
.btns { margin-top: 10px; display: flex; gap: 10px; }
.approve { background: #00c46b; color: #fff; }
.reject { background: #e63946; color: #fff; }
</style>
</head>
<body>
  <div class="container">
    <h1>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</h1>
    <div class="topbar">
      <button class="btn add" onclick="toggleAddSpeaker()">â• Ø¥Ø¶Ø§ÙØ© Ù…ØªØ­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</button>
      <button class="btn logout" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="statsBar">
      <div class="total">Ø¥Ø¬Ù…Ø§Ù„ÙŠ<span id="totalCount">0</span></div>
      <div class="approved">Ù…Ù‚Ø¨ÙˆÙ„<span id="approvedCount">0</span></div>
      <div class="rejected">Ù…Ø±ÙÙˆØ¶<span id="rejectedCount">0</span></div>
      <div class="pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©<span id="pendingCount">0</span></div>
    </div>

    <div id="recordsContainer">â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª...</div>
  </div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm";
const supabase = createClient(
  "https://qcctqvmwwpsoiexgdqwp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3Rxdm13d3Bzb2lleGdkcXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI1OTcsImV4cCI6MjA3ODI5ODU5N30.uTfskCuzkZNcvy1QdaOzqlW8km-wcZQoVRFi6k2xndQ"
);

const BUCKET = "recordings";
const container = document.getElementById("recordsContainer");

async function loadRecords() {
  container.innerHTML = "â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
  const { data, error } = await supabase
    .from("recordings")
    .select(`id, status, storage_path, speakers(name, gender, age_range, accent), texts(content)`)
    .order("created_at", { ascending: false });

  if (error || !data) {
    container.innerHTML = "<p>âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª.</p>";
    return;
  }

  let approved = 0, rejected = 0, pending = 0;
  data.forEach(r => {
    if (r.status === "approved") approved++;
    else if (r.status === "rejected") rejected++;
    else pending++;
  });

  document.getElementById("totalCount").textContent = data.length;
  document.getElementById("approvedCount").textContent = approved;
  document.getElementById("rejectedCount").textContent = rejected;
  document.getElementById("pendingCount").textContent = pending;

  container.innerHTML = "";
  for (const r of data) {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="status ${r.status}">Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status}</div>
      <h3>${r.speakers?.name || "Ù…Ø¬Ù‡ÙˆÙ„"}</h3>
      <p>ğŸ‘¤ ${r.speakers?.gender || "-"} | ğŸ‚ ${r.speakers?.age_range || "-"} | ğŸ—£ï¸ ${r.speakers?.accent || "-"}</p>
      <p>ğŸ’¬ ${r.texts?.content || "-"}</p>
      <audio controls src="https://qcctqvmwwpsoiexgdqwp.supabase.co/storage/v1/object/public/${BUCKET}/${r.storage_path}"></audio>
      <div class="btns">
        <button class="btn approve" onclick="updateStatus(${r.id}, 'approved')">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
        <button class="btn reject" onclick="updateStatus(${r.id}, 'rejected')">âŒ Ø±ÙØ¶</button>
      </div>`;
    container.appendChild(card);
  }
}

window.updateStatus = async function (id, status) {
  await supabase.from("recordings").update({ status }).eq("id", id);
  loadRecords();
};

window.logout = function () {
  localStorage.removeItem("admin_auth");
  location.href = "admin.html";
};

loadRecords();
</script>
</body>
</html>
