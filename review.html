
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© â€” ØµÙˆØªÙ†Ø§</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="container">
    <header class="row" style="justify-content:space-between;align-items:center">
      <h1 style="margin:0">Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª ğŸ› ï¸</h1>
      <div class="row">
        <a class="btn btn-ghost" href="./index.html">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button class="btn btn-ghost" id="logout">ğŸšª Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>
    <hr />
    <div id="list"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm';
    import { SUPABASE_URL, SUPABASE_ANON_KEY, BUCKET, ADMIN_PASSWORD } from './config.js';
    if(!localStorage.getItem('admin_auth')){ location.href='./admin.html'; }

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const list = document.getElementById('list');
    document.getElementById('logout').onclick = ()=>{ localStorage.removeItem('admin_auth'); location.href='./'; };

    async function loadAll(){
      list.innerHTML = '<div class="small">â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>';
      const { data, error } = await sb
        .from('recordings')
        .select('id,status,storage_path,created_at, speakers(name,gender,age_range,accent), texts(content)')
        .order('created_at', { ascending:false });
      if(error){ list.innerHTML = '<div class="small">âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</div>'; return; }
      list.innerHTML='';
      for(const r of data){
        const statusTag = r.status==='approved' ? '<span class="tag success">Ø§Ù„Ø­Ø§Ù„Ø©: approved</span>' :
                          r.status==='rejected' ? '<span class="tag danger">Ø§Ù„Ø­Ø§Ù„Ø©: rejected</span>' :
                          '<span class="tag warn">Ø§Ù„Ø­Ø§Ù„Ø©: pending</span>';
        const url = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${r.storage_path}`;
        const card = document.createElement('div');
        card.className='card';
        card.innerHTML = `
          <div class="row" style="justify-content:space-between;align-items:center">
            <div><strong>${r.speakers?.name || 'Ù…Ø¬Ù‡ÙˆÙ„'}</strong> â€” ${statusTag}</div>
            <div class="small">${new Date(r.created_at).toLocaleString('ar-EG')}</div>
          </div>
          <div class="small" style="margin:6px 0 8px">ğŸ—£ï¸ ${r.speakers?.accent || '-'} â€¢ ğŸ‚ ${r.speakers?.age_range||'-'} â€¢ ğŸ‘¤ ${r.speakers?.gender||'-'}</div>
          <div class="small">ğŸ’¬ Ø§Ù„Ù†Øµ: ${r.texts?.content || '-'}</div>
          <div style="margin-top:10px"><audio controls src="${url}"></audio></div>
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button class="btn btn-ghost" data-act="reject" data-id="${r.id}">âŒ Ø±ÙØ¶</button>
            <button class="btn" data-act="approve" data-id="${r.id}">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
          </div>
        `;
        list.appendChild(card);
      }
    }

    async function update(id, status){
      const { error } = await sb.from('recordings').update({ status }).eq('id', id);
      if(error){ alert('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«'); return; }
      loadAll();
    }

    list.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      update(btn.dataset.id, btn.dataset.act==='approve' ? 'approved' : 'rejected');
    });

    loadAll();
  </script>
</body>
</html>
