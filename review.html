<script>
  if (!localStorage.getItem("admin_auth")) {
    alert("ğŸ” ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    window.location.href = "admin.html";
  }
</script>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª - ØµÙˆØªÙ†Ø§</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#000;--bg2:#0d1b1e;--panel:#0f1518;--card:#0f1314;
    --brand:#00e0b6;--brand2:#00b4d8;--ok:#00c46b;--bad:#e63946;
    --pending:#ffaa33;--approved:#00ff88;--rejected:#ff5555;
  }
  body{
    font-family:"Cairo",sans-serif;background:radial-gradient(circle at top,var(--bg2),var(--bg));
    color:#fff;margin:0;padding:0;
  }
  .container{max-width:1050px;margin:20px auto;padding:20px}
  h1{text-align:center;color:var(--brand);margin:0 0 18px;
     text-shadow:0 0 15px rgba(0,224,198,.3)}
  .topbar{display:flex;justify-content:center;flex-wrap:wrap;gap:10px;margin-bottom:15px}
  .btn{padding:10px 18px;border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:.2s}
  .add{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff}
  .logout{background:#ff4d4d;color:#fff}.logout:hover{opacity:.9}
  /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
  #statsBar{display:flex;gap:8px;justify-content:space-around;background:var(--panel);
    border:1px solid var(--brand);border-radius:14px;padding:10px 8px;margin-bottom:14px}
  #statsBar>div{flex:1;text-align:center;color:#cfcfcf}
  #statsBar span{display:block;font-size:22px;font-weight:700}
  .approved{color:var(--approved)}.rejected{color:var(--rejected)}.pending{color:var(--pending)}
  /* Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØµÙÙŠØ© */
  .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:14px}
  .pills{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:8px 12px;border-radius:999px;background:#12181b;border:1px solid #1f2a2e;color:#cfd6d6;
        cursor:pointer;font-size:14px}
  .pill.active{background:#102a28;border-color:var(--brand);color:#cffff3;box-shadow:0 0 0 2px rgba(0,224,182,.15) inset}
  .search{display:flex;gap:8px;align-items:center}
  .search input{background:#0c0f10;border:1px solid #2a3236;border-radius:10px;color:#fff;padding:10px 12px;min-width:220px}
  /* Ø§Ù„ÙƒØ±ÙˆØª */
  .card{background:var(--card);border-radius:16px;padding:20px;margin-bottom:18px;box-shadow:0 4px 20px rgba(0,0,0,.5);transition:transform .2s}
  .card:hover{transform:translateY(-3px)}
  .status{font-size:14px;margin-bottom:5px}
  .status.pending{color:var(--pending)} .status.approved{color:var(--approved)} .status.rejected{color:var(--rejected)}
  .meta{color:#a9b2b3;margin:6px 0}
  .btns{margin-top:10px;display:flex;gap:10px}
  .approve{background:var(--ok);color:#fff}.reject{background:var(--bad);color:#fff}
  audio{width:100%;border-radius:8px}
  /* Ù„ÙˆØ¯ÙŠÙ†Øº ØµØºÙŠØ± */
  .muted{color:#a6b0b3}
</style>
</head>
<body>
  <div class="container">
    <h1>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</h1>

    <div class="topbar">
      <button class="btn add" onclick="toggleAddSpeaker()">â• Ø¥Ø¶Ø§ÙØ© Ù…ØªØ­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</button>
      <button class="btn logout" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>

    <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div id="statsBar">
      <div class="total">Ø¥Ø¬Ù…Ø§Ù„ÙŠ<span id="totalCount">0</span></div>
      <div class="approved">Ù…Ù‚Ø¨ÙˆÙ„<span id="approvedCount">0</span></div>
      <div class="rejected">Ù…Ø±ÙÙˆØ¶<span id="rejectedCount">0</span></div>
      <div class="pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©<span id="pendingCount">0</span></div>
    </div>

    <!-- Ø§Ù„ØªØµÙÙŠØ© + Ø§Ù„Ø¨Ø­Ø« -->
    <div class="filters">
      <div class="pills" id="statePills">
        <button class="pill active" data-state="all">Ø§Ù„ÙƒÙ„</button>
        <button class="pill" data-state="pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
        <button class="pill" data-state="approved">Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©</button>
        <button class="pill" data-state="rejected">Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©</button>
      </div>
      <div class="search">
        <input id="q" type="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ø§Ù„: Ø­Ø³Ù†)">
      </div>
    </div>

    <div id="recordsContainer" class="muted">â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª...</div>
  </div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm";
const supabase = createClient(
  "https://qcctqvmwwpsoiexgdqwp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3Rxdm13d3Bzb2lleGdkcXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI1OTcsImV4cCI6MjA3ODI5ODU5N30.uTfskCuzkZNcvy1QdaOzqlW8km-wcZQoVRFi6k2xndQ"
);
const BUCKET = "recordings";

const container = document.getElementById("recordsContainer");
const pills = document.getElementById("statePills");
const q = document.getElementById("q");

let allData = [];       // Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©
let currentState = "all";
let qTimer = null;

// ØªØ­Ù…ÙŠÙ„ + Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
async function loadRecords() {
  container.innerHTML = "â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
  const { data, error } = await supabase
    .from("recordings")
    .select(`id, status, storage_path, speakers(name, gender, age_range, accent), texts(content)`)
    .order("created_at", { ascending: false });

  if (error || !data) {
    container.innerHTML = "<p>âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª.</p>";
    return;
  }

  allData = data;
  updateStats(data);
  render(); // Ø·Ø¨Ù‚ Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
}

function updateStats(data){
  const approved = data.filter(r=>r.status==="approved").length;
  const rejected = data.filter(r=>r.status==="rejected").length;
  const pending  = data.filter(r=>r.status!=="approved" && r.status!=="rejected").length;

  document.getElementById("totalCount").textContent = data.length;
  document.getElementById("approvedCount").textContent = approved;
  document.getElementById("rejectedCount").textContent = rejected;
  document.getElementById("pendingCount").textContent  = pending;
}

// ØªØµÙÙŠØ© + Ø¨Ø­Ø«
function render(){
  let data = [...allData];

  if (currentState !== "all") data = data.filter(r => r.status === currentState);

  const term = q.value.trim();
  if (term){
    const t = term.toLowerCase();
    data = data.filter(r => (r.speakers?.name||"").toLowerCase().includes(t));
  }

  if (!data.length){
    container.innerHTML = `<p class="muted">Ù„Ø§ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</p>`;
    return;
  }

  container.innerHTML = "";
  for (const r of data) {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="status ${r.status}">Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status}</div>
      <h3>${r.speakers?.name || "Ù…Ø¬Ù‡ÙˆÙ„"}</h3>
      <p class="meta">ğŸ‘¤ ${r.speakers?.gender || "-"} | ğŸ‚ ${r.speakers?.age_range || "-"} | ğŸ—£ï¸ ${r.speakers?.accent || "-"}</p>
      <p>ğŸ’¬ ${r.texts?.content || "-"}</p>
      <audio controls src="https://qcctqvmwwpsoiexgdqwp.supabase.co/storage/v1/object/public/${BUCKET}/${r.storage_path}"></audio>
      <div class="btns">
        <button class="btn approve" onclick="updateStatus(${r.id}, 'approved')">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
        <button class="btn reject" onclick="updateStatus(${r.id}, 'rejected')">âŒ Ø±ÙØ¶</button>
      </div>`;
    container.appendChild(card);
  }
}

// Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø¨ÙˆØ¨ (Ø§Ù„ÙÙ„ØªØ±)
pills.addEventListener("click", (e)=>{
  const btn = e.target.closest(".pill");
  if(!btn) return;
  [...pills.children].forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  currentState = btn.dataset.state;
  render();
});

// Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… (Ø¯ÙŠØ¨Ø§ÙˆÙ†Ø³)
q.addEventListener("input", ()=>{
  clearTimeout(qTimer);
  qTimer = setTimeout(render, 200);
});

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
window.updateStatus = async function(id, status){
  await supabase.from("recordings").update({ status }).eq("id", id);
  await loadRecords();
};

// Ù†Ù…Ø§Ø°Ø¬ Ø¥Ø¶Ø§ÙÙŠØ© (Ù†ÙØ³ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
window.toggleAddSpeaker = function(){
  alert("ğŸ“Œ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ­Ø¯Ø« Ù…Ù† ØµÙØ­Ø© Ù…Ø³ØªÙ‚Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ².");
};
window.logout = function(){
  localStorage.removeItem("admin_auth");
  location.href = "admin.html";
};

loadRecords();
</script>
</body>
</html>
