
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>صوتنا – المراجعة</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="container">
    <header>
      <img src="logo-full.png" class="logo" alt="صوتنا"/>
      <h2>✅ صفحة المراجعة</h2>
      <p class="sub">تشغيل التسجيلات، ثم قبول أو رفض. (للمشرف فقط)</p>
    </header>

    <div class="panel">
      <div class="grid">
        <div class="field">
          <label>فلترة حسب المتحدث</label>
          <select id="speakerFilter"><option value="all">الكل</option></select>
        </div>
        <div class="field">
          <label>الحالة</label>
          <select id="statusFilter">
            <option value="pending">قيد المراجعة</option>
            <option value="approved">المقبولة</option>
            <option value="rejected">المرفوضة</option>
            <option value="all">الكل</option>
          </select>
        </div>
      </div>
    </div>

    <div id="list" class="list"></div>
    <p id="msg" class="notice"></p>

    <div class="footer">منصة صوتنا 2025</div>
  </div>

  <script type="module">
    if (!sessionStorage.getItem('sawtna_admin_ok')){
      const pw = prompt('أدخل كلمة مرور المشرف:');
      if(pw !== '70003mbgz'){ location.href = 'admin.html'; }
      else { sessionStorage.setItem('sawtna_admin_ok', '1'); }
    }

    import { supabase, BUCKET } from './config.js';
    const $=(s)=>document.querySelector(s);
    const speakerFilter=$('#speakerFilter');
    const statusFilter=$('#statusFilter');
    const list=$('#list'); const msg=$('#msg');

    async function loadSpeakers(){
      const sp=await supabase.from('speakers').select('id,code,name').order('code');
      speakerFilter.innerHTML = '<option value="all">الكل</option>' + (sp.data||[]).map(s=>`<option value="${s.id}">${s.code} — ${s.name||''}</option>`).join('');
    }

    async function loadList(){
      list.innerHTML=''; msg.textContent='جاري التحميل...';
      let q = supabase.from('recordings').select('id,speaker_id,text_id,storage_path,qa_status,created_at').order('created_at', {ascending:false}).limit(200);
      const st = statusFilter.value;
      if(st!=='all') q = q.eq('qa_status', st);
      const spId = speakerFilter.value;
      if(spId!=='all') q = q.eq('speaker_id', spId);
      const res=await q;
      msg.textContent='';
      if(res.error){ msg.textContent='خطأ: '+res.error.message; return; }
      for(const r of (res.data||[])){
        const sp=await supabase.from('speakers').select('code,name').eq('id', r.speaker_id).maybeSingle();
        const tx=await supabase.from('texts').select('code,content').eq('id', r.text_id).maybeSingle();
        const pub=supabase.storage.from(BUCKET).getPublicUrl(r.storage_path).data.publicUrl;
        const card=document.createElement('div'); card.className='card';
        card.innerHTML = `
          <div class="badge">${sp.data?.code||''} — ${sp.data?.name||''} · ${tx.data?.code||''}</div>
          <p class="small">${tx.data?.content || ''}</p>
          <audio controls src="${pub}"></audio>
          <div class="row">
            <button class="btn-ok" data-id="${r.id}" data-act="approve">قبول</button>
            <button class="btn-no" data-id="${r.id}" data-act="reject">رفض</button>
          </div>`;
        card.querySelectorAll('button').forEach(b => b.onclick = () => act(r.id, b.dataset.act));
        list.appendChild(card);
      }
    }
    async function act(id, action){
      const status = action === 'approve' ? 'approved' : 'rejected';
      const up = await supabase.from('recordings').update({ qa_status: status }).eq('id', id);
      if(up.error){ alert('فشل التحديث'); return; }
      await loadList();
    }
    await loadSpeakers();
    await loadList();
    speakerFilter.onchange = loadList;
    statusFilter.onchange = loadList;
  </script>
</body>
</html>
