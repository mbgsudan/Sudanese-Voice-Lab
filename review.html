<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª ğŸ› ï¸ | ØµÙˆØªÙ†Ø§</title>
  <link rel="stylesheet" href="styles.css"/>
  <script src="config.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm"></script>
</head>
<body>
  <script>
    // Ø­Ø§Ø±Ø³ Ø¯Ø®ÙˆÙ„: Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† auth Ù…ÙˆØ¬ÙˆØ¯ Ø£Ø¹Ø¯ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ admin.html
    if (!localStorage.getItem('admin_auth')) {
      window.location.href = 'admin.html';
    }
  </script>

  <div class="container">
    <h1>Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª ğŸ› ï¸</h1>

    <div class="topbar">
      <button class="btn outline" onclick="window.location.href='index.html'">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="btn warn" onclick="localStorage.removeItem('admin_auth');location.href='admin.html'">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="box"></div>
  </div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm";
  const sb = createClient(window.SAWTNA.SUPABASE_URL, window.SAWTNA.SUPABASE_ANON);
  const BUCKET = window.SAWTNA.BUCKET;
  const box = document.getElementById('box');

  function fileURL(p){ return `${window.SAWTNA.SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${p}`; }

  async function load(){
    box.innerHTML='<div class="card"><p class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p></div>';
    const { data, error } = await sb.from('recordings')
      .select('id,status,storage_path, speakers(name,gender,age_range,accent), texts(content)')
      .order('created_at',{ascending:false});
    if(error){ box.innerHTML='<div class="card"><p class="muted">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„.</p></div>'; return; }
    box.innerHTML='';
    (data||[]).forEach(r=>{
      const c=document.createElement('div'); c.className='card';
      c.innerHTML=`
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">${r.speakers?.name||'Ù…Ø¬Ù‡ÙˆÙ„'}</h2>
          <span class="status ${r.status}">Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status}</span>
        </div>
        <p class="gray">ğŸ‘¤ Ø§Ù„Ø¬Ù†Ø³: ${r.speakers?.gender||'-'} | ğŸ‚ Ø§Ù„Ø¹Ù…Ø±: ${r.speakers?.age_range||'-'} | ğŸ—£ï¸ Ø§Ù„Ù„Ù‡Ø¬Ø©: ${r.speakers?.accent||'-'}</p>
        <p class="muted">ğŸ’¬ Ø§Ù„Ù†Øµ: ${r.texts?.content||'-'}</p>
        <div class="audioBox"><audio controls src="${fileURL(r.storage_path)}"></audio></div>
        <div class="row">
          <button class="btn ok" data-id="${r.id}" data-act="approved">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
          <button class="btn bad" data-id="${r.id}" data-act="rejected">âŒ Ø±ÙØ¶</button>
        </div>`;
      box.appendChild(c);
    });

    box.querySelectorAll('button[data-id]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = +b.dataset.id; const act=b.dataset.act;
        b.disabled=true;
        const { error } = await sb.from('recordings').update({ status: act }).eq('id', id);
        if(error){ alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©'); b.disabled=false; return; }
        await load(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆÙ† ÙˆØ§Ù„Ø­Ø§Ù„Ø©
      });
    });
  }
  load();
</script>
</body>
</html>
