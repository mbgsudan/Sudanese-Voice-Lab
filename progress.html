<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>๐ ููุญุฉ ุงููุชุงุจุนุฉ โ ุตูุชูุง</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <img src="logo-full.png" class="logo" alt="ุตูุชูุง">
      <h2>๐ ููุญุฉ ูุชุงุจุนุฉ ุงููุดุฑูุน</h2>
    </header>

    <div id="login">
      <p>ุฃุฏุฎู ูููุฉ ูุฑูุฑ ุงููุดุฑู:</p>
      <input id="pw" type="password" placeholder="70003mbgz">
      <button id="loginBtn" class="btn">ุฏุฎูู</button>
      <p id="msg"></p>
    </div>

    <div id="dashboard" style="display:none">
      <section class="stats">
        <h3>ุฅุญุตุงุฆูุงุช ุนุงูุฉ</h3>
        <ul id="statsList">
          <li>ุฅุฌูุงูู ุงูุชุณุฌููุงุช: <span id="totalRec">0</span></li>
          <li>ุชูุช ุงูููุงููุฉ: <span id="approvedRec">0</span></li>
          <li>ููุฏ ุงููุฑุงุฌุนุฉ: <span id="pendingRec">0</span></li>
          <li>ูุฑููุถุฉ: <span id="rejectedRec">0</span></li>
          <li>ุนุฏุฏ ุงููุชุญุฏุซูู: <span id="speakersCount">0</span></li>
          <li>ุนุฏุฏ ุงููุตูุต ุงูููู: <span id="textsCount">0</span></li>
        </ul>
      </section>

      <section>
        <h3>๐๏ธ ุฃูุซุฑ ุงููุชุญุฏุซูู ูุดุงุทูุง</h3>
        <table id="speakerStats" border="1" cellpadding="8" style="width:100%">
          <thead><tr><th>ุงููุชุญุฏุซ</th><th>ุนุฏุฏ ุงูุชุณุฌููุงุช</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <section>
        <h3>๐๏ธ ุฃูุซุฑ ุงููุตูุต ุงุณุชุฎุฏุงููุง</h3>
        <table id="textStats" border="1" cellpadding="8" style="width:100%">
          <thead><tr><th>ุงููุต</th><th>ุนุฏุฏ ุงูุชุณุฌููุงุช</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/+esm';
    const supabase = createClient(
      "https://qcctqvmwwpsoiexgdqwp.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3Rxdm13d3Bzb2lleGdkcXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI1OTcsImV4cCI6MjA3ODI5ODU5N30.uTfskCuzkZNcvy1QdaOzqlW8km-wcZQoVRFi6k2xndQ"
    );

    const login = document.getElementById("login");
    const dashboard = document.getElementById("dashboard");
    const msg = document.getElementById("msg");

    document.getElementById("loginBtn").onclick = async () => {
      const pw = document.getElementById("pw").value;
      if (pw === "70003mbgz") {
        login.style.display = "none";
        dashboard.style.display = "block";
        loadData();
      } else msg.textContent = "ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ.";
    };

    async function loadData() {
      // ุฅุฌูุงูู ุงูุชุณุฌููุงุช
      const { data: recs } = await supabase.from("recordings").select("qa_status");
      const total = recs?.length || 0;
      const approved = recs?.filter(r=>r.qa_status==='approved').length || 0;
      const pending = recs?.filter(r=>r.qa_status==='pending').length || 0;
      const rejected = recs?.filter(r=>r.qa_status==='rejected').length || 0;

      document.getElementById("totalRec").textContent = total;
      document.getElementById("approvedRec").textContent = approved;
      document.getElementById("pendingRec").textContent = pending;
      document.getElementById("rejectedRec").textContent = rejected;

      // ุนุฏุฏ ุงููุชุญุฏุซูู ูุงููุตูุต
      const { count: spkCount } = await supabase.from("speakers").select("*", { count: "exact", head: true });
      const { count: txtCount } = await supabase.from("texts").select("*", { count: "exact", head: true });
      document.getElementById("speakersCount").textContent = spkCount || 0;
      document.getElementById("textsCount").textContent = txtCount || 0;

      // ุฃูุซุฑ ุงููุชุญุฏุซูู ูุดุงุทูุง
      const { data: speakerStats } = await supabase.rpc('get_speaker_stats');
      const tbody1 = document.querySelector("#speakerStats tbody");
      tbody1.innerHTML = speakerStats?.length
        ? speakerStats.map(s=>`<tr><td>${s.name}</td><td>${s.count}</td></tr>`).join('')
        : '<tr><td colspan="2">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>';

      // ุฃูุซุฑ ุงููุตูุต ุงุณุชุฎุฏุงููุง
      const { data: textStats } = await supabase.rpc('get_text_stats');
      const tbody2 = document.querySelector("#textStats tbody");
      tbody2.innerHTML = textStats?.length
        ? textStats.map(t=>`<tr><td>${t.content}</td><td>${t.count}</td></tr>`).join('')
        : '<tr><td colspan="2">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>';
    }
  </script>
</body>
</html>
